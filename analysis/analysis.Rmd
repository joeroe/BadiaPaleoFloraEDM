---
title: "Palaeodistribution of crop progenitors and wild foods in the Southern Levant"
author: "Joe Roe"
format: html
---

```{r dependencies}
library("dplyr")
library("ggplot2")
library("ggspatial")
library("parsnip")
library("purrr")
library("ranger")
library("rpaleoclim")
library("sf")
library("tibble")
library("tidyr")

library("BadiaPaleoFloraENM") # this package, install with devtools::install()
```

```{r definitions}
latlong <- 4326
utm37n <- 32637

w_asia <- st_bbox(c(xmin = 30, xmax = 50, ymin = 25, ymax = 40), crs = 4326)
s_levant <- st_bbox(c(xmin = 34, xmax = 39, ymin = 29, ymax = 34), crs = 4326)
```

## Introduction

## Background

## Methods and materials

```{r data-basemap}
# Turn off s2 while we deal with Natural Earth's dodgy geometries
use_s2 <- sf_use_s2(FALSE)

ne_countries <- read_sf(raw_data("ne"), "ne_10m_admin_0_countries")

ne_lakes <- read_sf(raw_data("ne"), "ne_10m_lakes") |> 
  st_geometry() |>
  st_crop(buffer_bbox(w_asia, 10)) |>
  st_union()

ne_ocean <- read_sf(raw_data("ne"), "ne_10m_ocean") |>
  st_geometry() |>
  st_crop(buffer_bbox(w_asia, 10)) |>
  st_union()

ne_land <- read_sf(raw_data("ne"), "ne_10m_land") |> 
  st_geometry() |>
  st_crop(buffer_bbox(w_asia, 10)) |>
  st_difference(ne_ocean) |>
  st_difference(ne_lakes) |>
  st_union()

s_levant_land <- st_intersection(st_as_sfc(s_levant), ne_land)

# Restore previous setting of s2
sf_use_s2(use_s2)
```

### Occurrence data

Occurrence data was obtained from GBIF.

```{r data-occ}
# Download or read data from GBIF
# TODO: T. boeoticum ? (equate with T. urartu?)
gbif_path <- here::here("analysis", "data", "derived_data", "gbif")
occ <- bind_rows(
  fetch_gbif("Hordeum", "spontaneum*", ext = w_asia, gbif_path),
  #fetch_gbif("Bolboschoenus", "glaucus*", ext = w_asia, gbif_path),    
  #fetch_gbif("Bolboschoenus", "maritimus*", ext = w_asia, gbif_path),    
  #fetch_gbif("Scirpus", "maritimus*", ext = w_asia, gbif_path),
  #fetch_gbif("Triticum", "urartu*", ext = w_asia, gbif_path),
  #fetch_gbif("Triticum", "dicoccoides*", ext = w_asia, gbif_path),
  #fetch_gbif("Stipa", "*", ext = w_asia, gbif_path),
  #fetch_gbif("Zilla", "spinosa*", ext = w_asia, gbif_path),
  #fetch_gbif("Vitex", "*", ext = w_asia, gbif_path),
  #fetch_gbif("Fraxinus", "*", ext = w_asia, gbif_path)
)

# Code taxonomic groups for analysis
occ |>
  mutate(taxon = case_when(genus == "Hordeum" ~ "Hordeum spontaneum",
                           genus == "Bolboschoenus" ~ "Bolboschoenus sp.",
                           species == "Triticum urartu" ~ "Triticum urartu",
                           species == "Triticum dicoccoides" ~ "Triticum dicoccoides",
                           genus == "Stipa" ~ "Stipa sp.",
                           genus == "Zilla" ~ "Zilla spinosa",
                           genus == "Vitex" ~ "Vitex sp.",
                           genus == "Fraxinus" ~ "Fraxinus sp.")) ->
  occ

# TODO: convert to a test
if(any(is.na(occ$taxon))) stop("Taxon contains missing values!")

# Remove duplicate records within analytic groups
occ |>
  group_by(taxon) |>
  distinct(lon, lat, .keep_all = TRUE) |>
  ungroup() ->
  occ

# Convert to sf
occ |>
  st_as_sf(coords = c("lon", "lat"), crs = 4326, remove = FALSE) ->
  occ
```

```{r plot-occ-distribution}
ggplot() + 
  layer_spatial(ne_land, fill = "#ffffff") +
  annotation_spatial(s_levant, fill = alpha("red", 0.15), colour = "red") +
  layer_spatial(occ, alpha = 0.1, symbol = 16) +
  # layer_spatial(ne_countries, fill = NA) +
  coord_sf(xlim = w_asia[c("xmin", "xmax")], 
           ylim = w_asia[c("ymin", "ymax")],
           crs = utm37n,
           default_crs = latlong)
```

<!-- TODO: following @ValaviEtAl2022, more accurate to call pseudo-absences
  "background samples" -->
Occurrence data only tells us where a species is present;
there is no definitive information on where the species is *not* found.
We therefore need to generate random background points or "pseudo-absences" to feed to the model.
There are several ways to do this. 
We follow the advice of Barbet-Massin et al. (2012) for regression-based species distribution models and use a large (~10000) random sample of points, weighted equally against the presences in the regression.
@ValaviEtAl2022 recommends using a very large background sample for random forest models.

```{r psabsences, include=FALSE}
n_background <- 1000

occ |>
  mutate(present = TRUE) |>
  bind_rows(background_sample(s_levant_land, 
                              n_background,
                              coord_x = "lon",
                              coord_y = "lat", 
                              taxon = "Hordeum spontaneum", 
                              present = FALSE)) ->
  occ

# Weights
#occ %>% 
#  group_by(taxon, occurrence) %>% 
#  mutate(weight = 1 + (n_psab / n() - 1)) ->
#  occ
```

### Climate data

```{r data-paleoclim}
tibble(period = c("lgm", "hs1", "ba", "yds", "eh", "cur")) |>
  mutate(raster = map(period, paleoclim, "2_5m", 
                      region = buffer_bbox(w_asia, 10),
                      cache_path = here::here(".paleoclim_cache"))) -> # TODO: revert to default cache
  climate

training_climate <- filter(climate, period == "cur")$raster[[1]]

occ |>
  mutate(bio = terra::extract(training_climate, data.frame(lon, lat), 
                              method = "bilinear", ID = FALSE)) |>
  unpack(bio) |>
  ungroup() ->
  occ
```

### Other predictor data

Soil, terrain (incl. TWI, slope?)

### Random Forest

```{r model}
rand_forest(mode = "regression") |>
  fit(as.numeric(present) ~ ., data = select(occ, present, starts_with("bio_"))) ->
  rf_fit
```

## Results

### Modelled ecological niches

* On current data
* Sensitivity to climate fluctuations

### Hindcasting

```{r predict}
predict(rf_fit, as.data.frame(filter(climate, period == "cur")$raster), type = "raw")
```

### Verification

## Discussion
