---
title: "Palaeodistribution of crop progenitors and wild foods in the Southern Levant"
author: "Joe Roe"
format: html
---

```{r dependencies}
library("dplyr")
library("fs")
library("ggplot2")
library("ggspatial")
library("here")
library("parsnip")
library("purrr")
library("ranger")
library("rpaleoclim")
library("sf")
library("stars")
library("stringr")
library("tibble")
library("tidyr")

library("BadiaPaleoFloraENM") # this package, install with devtools::install()
```

```{r definitions}
latlong <- 4326
utm37n <- 32637

w_asia <- st_bbox(c(xmin = 30, xmax = 50, ymin = 25, ymax = 40), crs = 4326)
s_levant <- st_bbox(c(xmin = 34, xmax = 39, ymin = 29, ymax = 34), crs = 4326)
```

## Introduction

## Background

## Methods and materials

```{r data-basemap}
# Turn off s2 while we deal with Natural Earth's dodgy geometries
use_s2 <- sf_use_s2(FALSE)

ne_countries <- read_sf(raw_data("ne"), "ne_10m_admin_0_countries")

ne_lakes <- read_sf(raw_data("ne"), "ne_10m_lakes") |> 
  st_geometry() |>
  st_crop(buffer_bbox(w_asia, 10)) |>
  st_union()

ne_ocean <- read_sf(raw_data("ne"), "ne_10m_ocean") |>
  st_geometry() |>
  st_crop(buffer_bbox(w_asia, 10)) |>
  st_union()

ne_land <- read_sf(raw_data("ne"), "ne_10m_land") |> 
  st_geometry() |>
  st_crop(buffer_bbox(w_asia, 10)) |>
  st_difference(ne_ocean) |>
  st_difference(ne_lakes) |>
  st_union()

s_levant_land <- st_intersection(st_as_sfc(s_levant), ne_land)

# Restore previous setting of s2
sf_use_s2(use_s2)
```

### Occurrence data

Occurrence data was obtained from GBIF.

```{r data-occ}
gbif_data <- function(scientificName, ...) {
  gbif_data <- rgbif::occ_data(scientificName = scientificName, ...)
  gbif_data$data
}

gbif_path <- here::here("analysis", "data", "derived_data", "gbif")

taxa <- c("Hordeum spontaneum" = "Hordeum spontaneum")
          # "Bolboshoenus spp." = "Bolboschoenus")

# Get occurrence data from GBIF
# Including only records with coordinates and no recorded issues with geospatial
#   data.
taxa |>
  map(gbif_data, hasCoordinate = TRUE, hasGeospatialIssue = FALSE, 
      geometry = w_asia, limit = 100000) |>
  list_rbind(names_to = "taxon") ->
  occ

# Exclude:
# * Coordinate uncertainty of 5 km or more (â‰ˆ2.5 mins)
# * Fossil occurrences
occ |>
  filter(coordinateUncertaintyInMeters < 5000 | is.na(coordinateUncertaintyInMeters)) |>
  filter(basisOfRecord != c("FOSSIL_SPECIMEN")) ->
  occ

# Remove duplicated coordinates (as recommended by CITE)
occ |>
  group_by(taxon) |>
  distinct(decimalLongitude, decimalLatitude, .keep_all = TRUE) |>
  ungroup() ->
  occ

# Convert to sf
occ |>
  st_as_sf(coords = c("decimalLongitude", "decimalLatitude"), 
           crs = 4326, remove = FALSE) ->
  occ
```

```{r plot-occ-distribution}
ggplot(occ) + 
  facet_wrap(vars(taxon)) +
  layer_spatial(ne_land, fill = "#ffffff") +
  annotation_spatial(s_levant, fill = alpha("red", 0.15), colour = "red") +
  layer_spatial(occ, alpha = 0.1, symbol = 16) +
  layer_spatial(ne_countries, fill = NA) +
  coord_sf(xlim = w_asia[c("xmin", "xmax")], 
           ylim = w_asia[c("ymin", "ymax")],
           crs = utm37n,
           default_crs = latlong)
```

<!-- TODO: following @ValaviEtAl2022, more accurate to call pseudo-absences
  "background samples" -->
Occurrence data only tells us where a species is present;
there is no definitive information on where the species is *not* found.
We therefore need to generate random background points or "pseudo-absences" to feed to the model.
There are several ways to do this. 
We follow the advice of Barbet-Massin et al. (2012) for regression-based species distribution models and use a large (~10000) random sample of points, weighted equally against the presences in the regression.
@ValaviEtAl2022 recommends using a very large background sample for random forest models.

```{r psabsences, include=FALSE}
n_background <- 10000

occ |>
  mutate(present = TRUE) |>
  bind_rows(background_sample(s_levant_land, 
                              n_background,
                              coord_x = "decimalLongitude",
                              coord_y = "decimalLatitude", 
                              taxon = "Hordeum spontaneum", 
                              present = FALSE)) ->
  occ
```

### Climate data

```{r data-climate}
raw_data("paleoclim") |>
  dir_ls() |>
  map(dir_ls, glob = "*.tif") |>
  map(read_stars) |>
  map(\(x) set_names(x, path_ext_remove(path_file(names(x))))) ->
  climate

# Tidy up names
names(climate) |>
  basename() |>
  str_remove(regex("chelsa_", ignore_case = TRUE)) |>
  str_split_i("_", 1) ->
  names(climate)
```

```{r training-climate}
occ <- cbind(occ, st_extract(climate$cur, occ))
```


### Other predictor data

Soil, terrain (incl. TWI, slope?)

### Random Forest

There are many methods for ENM.
Random Forest is one of the best performing, providing it is appropriately parameterised to account for the class imbalance between presence and background samples (balanced random forest) [@ValaviEtAl2021a; @ValaviEtAl2021b].

We used the R package ranger [@WrightZiegler2017].

```{r model}
# TODO: Where do the missing value(s) actually come from?
# Parameters adapted from the example of a down-sampled RF model given in
#   https://rvalavi.github.io/SDMwithRFs/#model-fitting-with-ranger-package
occ |>
  as_tibble() |>
  select(present, starts_with("bio")) |>
  drop_na() ->
  rf_data

# Model
# TODO: tune?
rand_forest(mode = "classification", trees = 1000) |>
  set_engine(
    "ranger",
    probability = TRUE,
    sample.fraction = c(2250 / n_background, 1), # TODO: parameterise
  ) -> 
  rf_model 

# Fit
rf_fit <- fit(rf_model, factor(present) ~ ., data = rf_data)
```

## Results

### Modelled ecological niches

* On current data
* Sensitivity to climate fluctuations

### Hindcasting

```{r predict}
# TODO: predict on all periods (maybe combine stars and collapse into dimension first?)
rf_pred_cur <- predict(climate$cur, rf_fit)
rf_pred_eh <- predict(climate$EH, rf_fit)
```

### Verification

## Discussion
