---
title: Biogeography of crop progenitors and wild plant resources in Late Pleistocene–Early Holocene West Asia, 21–8.3 ka
date: today
author: 
- name: Joe Roe
  id: jr
  orcid: 0000-0002-1011-1244
  email: joeroe@hey.com
  affiliations:
    - name: University of Bern
      country: Switzerland
    - name: University of Copenhagen
      country: Denmark
  corresponding: true
- name: Amaia Arranz-Otaegui
  id: aao
  orcid: 0000-0002-5091-6426
  affiliation: 
    - name: University of the Basque Country
      country: Spain
abstract: |
  This paper presents the first comprehensive reconstructions of the 
  palaeodistributions of 56 plant species found regularly in association with
  early agricultural archaeological sites in West Asia, including the 
  progenitors of the first crops. We used machine learning to train an 
  ecological niche model of each species based on its present-day distribution 
  in relation to climate and environmental variables. Predictions of the 
  potential ranges of these species at key stages of the Pleistocene–Holocene 
  transition could then be derived from these models using hindcast data from 
  palaeoclimate simulations.
  Species ranges are predicted to have been on average [X%] [larger|smaller] in 
  the Early Holocene compared to present conditions, indicating [...]. 
  The modelled ranges predict the observed occurrence of these species on 
  archaeological sites with [low|medium|high] accuracy. The regional ubiquity of 
  species in the archaeological record is [not] correlated with the predicted 
  size of its range and the diversity of archaeobotanical assemblages is [not] 
  correlated with the predicted diversity of its environs. This indicates that 
  trends in taxonomic composition of the archaeobotanical record is [not] likely 
  to have been influenced by environmental change and species turnover, in
  addition to human economic choices.
format: 
  elsevier-pdf:
    keep-tex: true
    # cite-method: citeproc
    journal:
      name: Open Quaternary
      formatting: review
      cite-style: authoryear
bibliography: references.bib
execute: 
  echo: false
---

* [x] Finish modelling
- [ ] First draft:
  - [ ] Introduction
  - [ ] Background
    - [ ] Biogeography
    - [x] ENM
  - [x] Methods & Materials
  - [ ] Results
    - [ ] Model assessment
    - [ ] Hindcasting
  - [ ] Discussion
    - [ ] General trends
    - [ ] Case studies
  - [ ] Conclusion
- [ ] Figures
  - [ ] tbl-occ-count (needs pdf cleanup)
  - [ ] tbl-predictors
  - [ ] tbl-climate-periods
- [ ] Clean up package code
- [ ] Appendix with all hindcast predictions
- [ ] References & copyediting
- [ ] Final proofread

```{r dependencies, message=FALSE}
library("cowplot")
library("dplyr")
library("dotenv")
library("english")
library("forcats")
library("fs")
library("furrr")
library("ggplot2")
library("ggrepel")
library("ggspatial")
library("gt")
library("here")
library("khroma")
library("progressr")
library("purrr")
library("ranger")
library("readr")
library("recipes")
library("rgbif")
library("scales")
library("sf")
library("stars")
library("stringr")
library("tibble")
library("tidymodels")
library("tidyr")

library("BadiaPaleoFloraENM") # this package, install with devtools::install()
```

```{r setup-parallel}
# Several parts of this analysis are processing- and memory-intensive.
# You may need to adjust the futures strategy specified here to fit your 
# computational resources. See ?future::plan for options.
plan("multisession")
```

```{r define-regions}
latlong <- 4326
w_asia_albers <- "+proj=aea +lat_1=22.5 +lat_2=42.5 +lon_0=40"

w_asia <- st_bbox(c(xmin = 25, xmax = 55, ymin = 22.5, ymax = 42.5), crs = 4326)
s_levant <- st_bbox(c(xmin = 34, xmax = 39, ymin = 29, ymax = 34), crs = 4326)
```

```{r define-periods}
archaeo_periods <- tribble(
  ~period,             ~agriculture,                          ~start_bp, ~end_bp,
  "Late Epipal.",      "Foraging",                            15000,     11700,
  "PPNA",              "Pre-domestication cultivation",       11700,     10700,
  "EPPNB",             "Cultivation of domesticated species", 10700,     10200,
  "MPPNB",             "Cultivation of domesticated species", 10200,     9500,
  "LPPNB/C",           "Agriculture",                         9500,      8500,
  "Pottery Neolithic", "Agriculture",                         8500,      6500,
  "Chalcolithic",      "Agriculture",                         6500,      5000,
)

neolithic <- c("PPNA", "EPPNB", "MPPNB", "LPPNB/C", "Pottery Neolithic")

climate_periods <- tibble(
  period = c("Last Glacial Maximum", "Heinrich Stadial 1", "Bølling-Allerød",
             "Younger Dryas", "Early Holocene", "Current"),
  code = c("lgm", "hs1", "ba", "yds", "eh", "cur"),
  label = fct_inorder(c("LGM (21 ka)", "HS1 (17.0-14.7 ka)", "BA (14.7-12.9 ka)", 
            "YDS (12.9-11.7 ka)", "EH (11.7-8.3 ka)", "current")),
  start_bp = c(21000, 17000, 14700, 12900, 11700, NA),
  end_bp = c(17000, 14700, 12900, 11700, 8300, NA)
)
```

```{r define-parameters}
# Minimum number of GBIF occurrences for modelling
min_n_occ <- 50

# Number of background samples per taxon
n_background <- 10000

# Raster resolution for prediction (meters)
pred_res <- 5000
```

# Introduction

* The first farming societies had an ecological context
* Subsistence is understood (largely) through archaeobotany and zooarchaeology; ecological context from environmental archaeology, palynology, palaeoclimate records, etc.
  * But these have a variety of biases (human selection, taphonomy, etc.)
  * And at the end of the day only represent specific places – interpolation to the entire region is not straightforward
  * Overlap makes it difficult to see where human choices depart from the environmental background [cf. @MartinEtAl2016]
  * Or to fully contextualise subsistence strategies and shifts in strategies in response to environmental shifts [e.g. @YaworskyEtAl2023].
* Here we present an alternative approach using ENM
  * Whole region, at multiple climate snapshots
  * Independent of archaeobot. and pal. clim. data, so can verify and compare

# Background

* The transition to agriculture in West Asia was...

## Biogeography and agricultural origins

* Has always been important in study of agricultural origins
  * Historically: Vavilov, Pumpelly & Childe
  * Genetic studies tell us origin points, but not ranges
* Important to e.g.
  * Distinguish environmental from potentially anthropogenic change [@MartinEtAl2017; @MartinEtAl2025]
  * Reconstruct sequences of domestication [@YeomansEtAl2017]
* Epipal./Neo. plant-based economies were diverse
  * More than the "founder crops"; 
  * More than food
  * (In archaebot., not all intentionally collected)
  * Regionally and temporally diverse
  * ...so we model lots of species!
* Regional ecological reconstructions generally rely on the 'expert interpolation' (or what do they call it with isoscapes?) method
  * See CSEAS (AEA-prep) presentation
  * Figure: comparisons

## Ecological niche modelling in archaeology

<!-- TODO: more citations? -->
Ecological niche modelling (ENM) or species distribution modelling (SDM) is widely used by ecologists to predict the geographic range of a species based on a set of environmental predictors.
Essentially, it involves combining records of where an organism has been observed with environmental data (climate, topography, etc.) for those locations to model the range of environmental values at which that species  – its environmental niche.
This model can then be used to predict the range of the organism in question either in the same or a different environment.
@CITE suggests reserving the term 'species distribution modelling' for when the method is used to recover the verifiable range of a species in a real and existing environment, and using 'ecological niche modelling' as the broader term covering hypothetical or predictive applications – a convention we follow here when referring to predictive or 'hindcast' models of past ranges.
Within this overarching framework, ecological niche modelling encompasses a wide range of applications and a variety of potential environmental predictors, modelling approaches, and methodologies, which we will not attempt to review here.

Ecological niche modelling has long been of interest to archaeologists as both a means of exploring the biological niche of humans and for reconstructing the past environments they inhabited [@DavidPollyEronen2011; @FranklinEtAl2015].
In the first sense, it has been used most extensively to model the range of humans and other hominin species [e.g. @BenitoEtAl2017; @YousefiEtAl2020; @BanksEtAl2021; @YaworskyEtAl2024a; @YaworskyEtAl2024b; @GuranEtAl2024], especially in the Palaeolithic.
This overlaps with what archaeologists usually call generically 'predictive modelling' [@VerhagenWhitley2020]—more precisely 'site distribution modelling'—which is essentially the same approach as (and often borrows methodologies from) ecological niche modelling but applied to the occurrence of archaeological sites.
Here what is modelled is not strictly a biological niche alone, but also aspects of human geography, taphonomy, and archaeological visibility.
These applications can be distinguihed from 'palaeoecological niche modelling', where the object of model remains, as in ecology, a non-human biological niche.

@FranklinEtAl2015 review palaeoecological niche modelling and advocate for its greater adoption in environmental archaeology.
In an early application to West Asia, @ConollyEtAl2012 used the occurrence of wild and domestic *Bos* remains at prehistoric archaeological sites to map the evolving niche of cattle over the Pleistocene–Holocene transition.
It has been used to model the availability of fauna exploited by humans at wider scales [e.g. @deAndresHerreroEtAl2018; @YaworksyEtAl2023] and, in a West Asian context, of foraged plant resources in the landscape around the Neolithic site of XX<!-- TODO: Kortik? --> [@CollinsEtAl2018].
Modelling the spread of crops has been another significant archaeological application [@CremaEtAl].

In the majority of studies to date (palaeo)ecological niche modelling has been applied to archaeological data in an 'inductive' fashion, i.e. faunal and botanical remains from ancient sites are used as the occurrence dataset for training a model using either past or present environmental data.
However, both the zooarchaeological and archaeobotanical records are sparse and subject to a complex array of depositional, taphonomic and recovery biases factors that , many of which are not fully understood and/or cannot be corrected for.
This means that while the archaeological attestation of the presence of a species might generally be relied upon, it is highly unlikely that its absence is representative of true past distributions.

The alternative approach is to train the model using contemporary occurrence and environmental data and then use palaeoenvironmental data to 'hindcast' its predictions backwards in time.
Like @FranklinEtAl2015, we view the hindcasting approach as more promising, because training datasets for both occurrences and environment are far more readily available, complete and reliable for the present than the past.
There is some scepticism in the ecological niche modelling literature about the ability of such models to make accurate predictions in unknown environments (like the past) [@CITES?], 
but here the hindcasting approach also presents an opportunity:
it reserves archaeological occurrence data as an independent dataset that can be used to assess the retrodictive performance of the model.
This possibily was suggested by @FranklinEtAl2015 but to our knowledge our study represents the first attempt to actually do so.

The major practical limitation of the hindcasting approach is that it relies on spatially explicit, high resolution palaeoenvironmental surfaces with continuous coverage of the region and periods of interest.
Until recently, this has not been widely available for most applications, which is perhaps why only a minority of studies use it [cf. @YaworskyEtAl2023].
In this study, we are able to take advantage of the increasing availability of high resolution, global palaeoclimate data derived from simulation experiments with general circulation models of climate [@BrownEtAl2018; @BrownEtAl2020; @KargerEtAl2023].
<!-- TODO: mention that GBIF, CHELSA, SoilGrids, WorldClim, DEMs, etc. are also great? -->

# Methods and materials

```{r data-basemap, message=FALSE}
# Turn off s2 while we deal with Natural Earth's dodgy geometries
use_s2 <- sf_use_s2(FALSE)

ne_countries <- read_sf(raw_data("ne"), "ne_10m_admin_0_countries")

ne_lakes <- read_sf(raw_data("ne"), "ne_10m_lakes") |> 
  st_geometry() |>
  st_crop(buffer_bbox(w_asia, 10)) |>
  st_union()

ne_ocean <- read_sf(raw_data("ne"), "ne_10m_ocean") |>
  st_geometry() |>
  st_crop(buffer_bbox(w_asia, 10)) |>
  st_union()

ne_land <- read_sf(raw_data("ne"), "ne_10m_land") |> 
  st_geometry() |>
  st_crop(buffer_bbox(w_asia, 10)) |>
  st_difference(ne_ocean) |>
  st_difference(ne_lakes) |>
  st_union()

s_levant_land <- st_intersection(st_as_sfc(s_levant), ne_land)
w_asia_land <- st_intersection(st_as_sfc(w_asia), ne_land)

# Restore previous setting of s2
sf_use_s2(use_s2)
```

```{r fig-region}
#| fig-cap: Study region
ggplot() + 
  annotation_spatial(ne_land, fill = "#ffffff") +
  layer_spatial(w_asia, fill = NA) +
  coord_sf(crs = w_asia_albers)
```

<!-- TODO define study region and period -->

```{r data-archaeo-flora}
# Flora present at archaeological sites
archaeo_flora <- read_tsv(
  raw_data("swasia_neolithic_flora.tsv"),
  col_types = cols(
    source = col_character(),
    source_id = col_character(),
    source_site_name = col_character(),
    site_name = col_character(),
    latitude = col_double(),
    longitude = col_double(),
    phase = col_character(),
    phase_description = col_character(),
    phase_code = col_character(),
    age_start = col_integer(),
    age_end = col_integer(),
    taxon_source = col_character(),
    n = col_double(),
    prop = col_double(),
    reference = col_character(),
    taxon_detail = col_character(),
    taxon = col_character(),
    genus = col_character(),
    family = col_character(),
    category = col_character(),
    founder_crop = col_character(),
    edibility = col_character(),
    grass_type = col_character(),
    legume_type = col_character()
  )
) |>
  rename(taxon_group = "taxon", taxon = "taxon_detail") |>
  # Assign to archaeological periods
  mutate(
    age_mid = age_end + ((age_start - age_end) / 2),
    period = cut(
      -age_mid, 
      breaks = -c(archaeo_periods$start_bp, 0), 
      labels = archaeo_periods$period,
      ordered_result = TRUE
    ),
    climate_period = cut(
      -age_mid, 
      breaks = -c(climate_periods[climate_periods$code != "cur",]$start_bp, 0), 
      labels = climate_periods[climate_periods$code != "cur",]$code,
      ordered_result = TRUE
    )
  ) ->
  archaeo_flora

n_assemb_neolithic <- archaeo_flora |> 
  distinct(site_name, phase_code, period) |> 
  filter(period %in% neolithic) |> 
  nrow()

n_site_neolithic <- archaeo_flora |> 
  filter(period %in% neolithic) |> 
  distinct(site_name) |> 
  nrow()
```

```{r data-flora}
if (!file_exists(derived_data("flora.tsv"))) {
  message("Regenerating flora...")
  # Subset of flora to be modelled
  archaeo_flora |>
    filter(period %in% neolithic) |>
    group_by(taxon) |>
    summarise(
      n_present = length(unique(phase_code)),
      p_present = n_present / n_assemb_neolithic,
      .groups = "drop"
    ) |>
    filter(n_present > 2) |>
    # Exclude taxa not identified to species
    filter(!str_ends(taxon, "sp.")) ->
    flora
  
  # Standardise taxonomy
  flora <- flora |>
    # Normalise species names and match to the GBIF Backbone Taxonomy
    mutate(
      taxon = case_match(taxon,
                         "Vicia narbonense" ~ "Vicia narbonensis", # N=3
                         "Triticum aestivocompactum" ~ "Triticum aestivum compactum", # N=3
                         "Heliotropium persicum" ~ "Moltkia angustifolia", # N=2
                         "Lens orientalis" ~ "Vicia orientalis", # N=2
                         "Scirpus tabernaemontani" ~ "Schoenoplectus tabernaemontani", # N=2
                         "Stipa capensis" ~ "Stipa dregeana", # N=2
                         .default = taxon),
      taxon_original = taxon,
      taxon = map_chr(taxon, gbif_accepted_name)
    ) |>
    # Recode domesticates as their wild progenitors.
    mutate(
      taxon = case_match(
        taxon,
        "Cicer arietinum" ~ "Cicer reticulatum",
        "Hordeum vulgare" ~ "Hordeum spontaneum",
        "Vicia lens" ~ "Vicia orientalis",
        "Linum usitatissimum" ~ "Linum bienne",
        "Triticum aestivum" ~ "Triticum turgidum dicoccum",
        "Triticum dicoccoides" ~ "Triticum turgidum dicoccum",
        "Triticum turgidum durum" ~ "Triticum turgidum dicoccum",
        "Triticum monococcum" ~ "Triticum monococcum aegilopoides",
        .default = taxon
      )
    ) |>
    # Add wild progenitors of wheats
    bind_rows(
      tibble(
        taxon = c("Triticum urartu", "Aegilops speltoides", "Aegilops tauschii"),
        taxon_original = c("Triticum urartu", "Aegilops speltoides", "Aegilops tauschii")
      )
    ) |>
    # Deduplicate by canonical taxon
    summarise(
      taxon_detail = paste0("*", taxon_original[taxon_original != taxon], "*", collapse = ", "),
      taxon_detail = na_if(taxon_detail, "**"),
      n_present = max(n_present),
      p_present = max(p_present),
      .by = taxon
    )
  
  write_tsv(flora, derived_data("flora.tsv"))
}

flora <- read_tsv(
  derived_data("flora.tsv"),
  col_types = cols(
    taxon = col_character(),
    taxon_detail = col_character(),
    n_present = col_double(),
    p_present = col_double()
  )
)
```

We began by considering `r nrow(flora)` distinct taxa (@tbl-occ-count) - all the identifiable species known to be present at more than three Neolithic (c. 11.7–6.5 ka) sites in West Asia, according to our previous study of the regional archaeobotanical data [@ArranzOtaeguiRoe2023].
<!-- TODO: something about not distinguishing between source of plant remains? -->
Taxonomic names were resolved to the canonical form specified in the GBIF Backbone Taxonomy [@GBIFSecretariat2023].
So for example occurrences for *Bolboschoenus maritimus* also include those recorded under the older nomenclature *Scirpus maritimus* (see @tbl-occ-count).
Domestic species meeting our inclusion criteria were substituted with their wild progenitor(s), where known.

## Occurrence data

```{r data-occ-count}
if (!file_exists(derived_data("flora_occ_count.tsv"))) {
  message("Reacquiring GBIF occurrence counts...")
  flora <- flora |>
    mutate(
      n_occ = map_dbl(taxon, \(x) occ_count(scientificName = x, 
                                            hasCoordinate = TRUE, 
                                            hasGeospatialIssue = FALSE,
                                            geometry = bbox_wkt(w_asia)))
    )
  write_tsv(flora, derived_data("flora_occ_count.tsv"))
}
flora <- read_tsv(
  derived_data("flora_occ_count.tsv"),
  col_types = cols(
    taxon = col_character(),
    taxon_detail = col_character(),
    n_present = col_double(),
    p_present = col_double(),
    n_occ = col_double()
  )
)
```

```{r tbl-occ-count}
#| tbl-cap: "Recorded occurrence of flora considered in this study in Neolithic and contemporary West Asia"
flora |>
  mutate(
    exclude = (n_occ < min_n_occ) | (taxon == "Avena sterilis"),
    label = if_else(
      !is.na(taxon_detail),
      glue::glue("*{taxon}*\n\n<small>incl. {taxon_detail}</small>"),
      paste0("*", taxon, "*")
    )
  ) |>
  select(label, n_present, p_present, n_occ, exclude) |>
  arrange(-n_present) |>
  gt() |>
  cols_label(
    label = "Taxon",
    n_present = "Neolithic",
    n_occ = "Present"
  ) |>
  tab_spanner("Occurrences", columns = starts_with("n_")) |>
  cols_merge_n_pct(n_present, p_present) |>
  cols_hide(exclude) |>
  tab_footnote(
    "Excluded from modelling due to sample size", 
    cells_body(columns = c(n_occ), rows = exclude),
    placement = "right"
  ) |>
  cols_align("left", c(label)) |>
  fmt_percent(p_present, decimals = 0) |>
  fmt_markdown(label) |>
  sub_missing() |>
  tab_options(footnotes.marks = "*")
```

Georeferenced occurrence data was obtained from the Global Biodiversity Information Facility (GBIF) using via its application programming interface and the R package 'rgbif' [@ChamberlainBoettiger2017; @rgbif].
GBIF occurrences marked has having imprecise or duplicate coordinates were excluded from the training dataset, as were fossil records.
Although niche models have reasonable predictive power even with small training samples [@StockwellPeterson2002; @HernandezEtAl2006; @WiszEtAl2008], we excluded `r english(nrow(filter(flora, n_occ > min_n_occ)))` taxa with less than `r min_n_occ` occurrences in West Asia, following recommendations for niche models generally and Random Forest-based models specifically [@StockwellPeterson2002; @LuanEtAl2020].
We also excluded one taxon (*Avena sterilis*) with over 50,000 occurrences, as this would have been computationally prohibitive and we were uncertain what account for such a disproportionately high number of records.

```{r filter-flora}
flora <- filter(flora, n_occ > min_n_occ)
# Why are there 50k occurrences of Avena sterilis??
flora <- filter(flora, taxon != "Avena sterilis")
```

```{r fetch-occ}
# TODO: further tidying. Ideas:
# - https://data-blog.gbif.org/post/gbif-filtering-guide/
# - https://cran.r-project.org/web/packages/CoordinateCleaner/vignettes/Cleaning_GBIF_data_with_CoordinateCleaner.html
# - https://www.r-bloggers.com/2021/03/downloading-and-cleaning-gbif-data-with-r/
if (!file_exists(derived_data("flora_occ.tsv"))) {
  message("Reacquiring GBIF occurrences...")
  flora <- mutate(
    flora,
    occ = map(
      taxon, gbif_data, 
      hasCoordinate = TRUE, hasGeospatialIssue = FALSE, geometry = w_asia, 
      limit = 100000, .progress = TRUE
    ),
    occ = map(occ, gbif_drop_imprecise_coords, threshold = 5000),
    occ = map(occ, gbif_drop_fossils),
    occ = map(occ, gbif_drop_duplicate_coords),
    occ = map(occ, gbif_standardise_names),
    occ = map(occ, \(x) {
      select(x, gbif_key = key, scientific_name, genus, species, longitude, 
             latitude)
    })
  )
  write_tsv(unnest(flora, cols = c(occ)), derived_data("flora_occ.tsv"))
}
flora <- read_tsv(
  derived_data("flora_occ.tsv"),
  col_types = cols(
    taxon = col_character(),
    taxon_detail = col_character(),
    n_present = col_double(),
    p_present = col_double(),
    n_occ = col_double(),
    gbif_key = col_double(),
    scientific_name = col_character(),
    genus = col_character(),
    species = col_character(),
    longitude = col_double(),
    latitude = col_double()
  )
) |>
  nest(occ = gbif_key:latitude)
```

```{r fig-occ-map}
# TODO: Can this be made presentable?
#flora |>
#  unnest(occ) |>
#  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) |>
#  ggplot() + 
#  facet_wrap(vars(taxon)) +
#  layer_spatial(ne_land, fill = "#ffffff") +
#  geom_sf(shape = ".") +
#  coord_sf(xlim = w_asia[c("xmin", "xmax")], 
#           ylim = w_asia[c("ymin", "ymax")],
#           crs = w_asia_albers,
#           default_crs = latlong)
```

```{r data-background}
# TODO: slow - cache
flora <- flora |>
  mutate(
    occ = map(occ, mutate, present = TRUE, weight = 1),
    bg = map(occ, function(x, region, n) { 
      background_sample(
        region = region, 
        N = n,
        coord_x = "longitude", coord_y = "latitude",
        present = FALSE,
        weight = (1 / n) * nrow(x) # weight presences and background equally
      )
    }, region = w_asia_land, n = n_background),
    # occ_bg = map2(occ, bg, bind_rows)
    occ = map2(occ, bg, bind_rows)
  ) |>
  select(-bg)
```

<!-- TODO: rewrite -->
Occurrence data only tells us where a species is present;
there is rarely definitive information on where the species is *not* found.
We therefore need to generate random background points or "pseudo-absences" to feed to the model.
There are several ways to do this. 
We follow the advice of @BarbetMassinEtAl2012 for regression-based species distribution models and use a large (:10000) random sample of points, weighted equally against the presences in the regression.
@ValaviEtAl2022 also recommend using a very large background sample for random forest models.

## Predictor data

We modelled the occurrence of species as a function of <!-- TODO -->X spatial predictor variables (@tbl-predictors).
These included:

```{r data-climate}
# Reacquire derived_data/paleoclim if needed:
if (length(dir_ls(derived_data("paleoclim"), glob = "*.tif")) < 1) {
  message("Redownloading Paleoclim data...")
  source(here("data", "data-paleoclim.R"))
}

climate <- read_stars(
  derived_data(
    "paleoclim", 
    paste0("paleoclim_", climate_periods$code, "_2_5m_w_asia.tif")
  ),
  along = NA
)

names(climate) <- climate_periods$code

climate <- st_redimension(climate, name = "period") |>
  split("band")
```

* Sixteen 'bioclimatic' variables derived from monthly temperature and precipitation values, following standard practice for species distribution models [@HijmansEtAl2005]. Contemporary bioclimatic predictor data for West Asia was extracted from the global CHELSA dataset [@KargerEtAl2017], which predicts temperature and precipitation from downscaled general circulation model output at 1 km resolution.

```{r data-terrain}
# Reacquire derived_data/srtm_15plus_w_asia.tif if needed:
if (!file_exists(derived_data("dem", "srtm_15plus_w_asia.tif"))) {
  message("Redownloading DEM data...")
  source(here("data", "data-dem.R"))
}

terrain <- read_stars(derived_data("dem", c("srtm_15plus_w_asia.tif", 
                                            "srtm_15plus_w_asia_slope.tif",
                                            "srtm_15plus_w_asia_aspect.tif",
                                            "srtm_15plus_w_asia_wetness.tif")))
names(terrain) <- c("elevation", "slope", "aspect", "wetness")
```

* Terrain aspect and slope, which at high resolution perform well as proxies for solar radiation when modelling plant occurrence [@AustinVanNiel2011; @LeempoelEtAl2015]; and the topographic wetness index (TWI), which serves as a proxy for soil moisture and is particularly important in modelling arid environments [@KopeckyCizkova2010; @CamposEtAl2016; @DiVirgilioEtAl2018]. All three were derived from the SRTM15+ digital elevation model using algorithms from WhiteboxTools [@Lindsay2016].

```{r data-soil}
# Reacquire derived_data/soilgrids if needed:
if (length(dir_ls(derived_data("soilgrids"), glob = "*.tif")) < 1) {
  message("Redownloading SoilGrids data...")
  source(here("data", "data-soilgrids.R"))
}

soil <- map(dir_ls(derived_data("soilgrids")), read_stars)
names(soil) <- str_split_i(basename(names(soil)), "_", 2)
soil <- do.call(c, soil)
```

* Edaphic data from SoilGrids [@HenglEtAl2014; @HenglEtAl2017], which improves model performance for plants [@DubuisEtAl2013; @ModEtAl2016; @VelazcoEtAl2017]. Based on a recent assessment of the reliability of SoilGrids data for species distribution modelling [@MillerEtAl2024], we used a subset of four variables relating to soil texture (clay, silt, sand) and pH at the surface (0-5 cm depth).

```{r data-environment}
# Prepare environmental data cube for prediction (not training)
# Duplicate time-invariant predictors to create dummy period dimension
terrain_cube <- list(terrain) |>
  rep(nrow(climate_periods)) |>
  set_names(climate_periods$code) |>
  c(list(along = "period")) |>
  do.call(what = c)

soil_cube <- list(soil) |>
  rep(nrow(climate_periods)) |>
  set_names(climate_periods$code) |>
  c(list(along = "period")) |>
  do.call(what = c)

# Resample predictor data to common projection and resolution
climate_cube <- st_warp(climate, crs = w_asia_albers, 
                        cellsize = c(pred_res, pred_res))
terrain_cube <- st_warp(terrain_cube, climate_cube)
soil_cube <- st_warp(soil_cube, climate_cube)

# Combine into prediction cube
environment <- c(climate_cube, terrain_cube, soil_cube)

# Save some memory
rm(climate_cube, terrain_cube, soil_cube)
```

Predictor data was transformed to common equal-area projection and resolution of `r pred_res / 1000` km.

```{r tbl-climate-periods}
#| fig-cap: Palaeoclimatic periods used for hindcasting, after @BrownEtAl2018
# TODO: add refs (as footnotes?)
climate_periods |>
  mutate(
    code = toupper(code),
    age_start = start_bp / 1000,
    age_end = end_bp / 1000
  ) |>
  select(period, code, age_start, age_end) |>
  gt() |>
  cols_label(period = "Period", age_start = "Age") |>
  cols_merge(
    c(period, code),
    pattern = "{1} ({2})"
  ) |>
  cols_merge_range(age_start, age_end) |>
  cols_units(age_start = "ka") |>
  sub_missing()
```

For hindcasting, we used reconstructed bioclimatic data for `r english(nrow(climate_periods) - 1)` key periods (@tbl-climate-periods) generated from downscaled paleoclimate simulations from the HadCM3 general circulation model [@BrownEtAl2018].
Terrain and soil predictors were held constant, since reconstructions of these variables in the past are not available at sufficient scale.
It is not likely that either macroscale topography or soil characteristics have altered significantly over the period of time considered here, so we assume that this does not degrade model performance, and may in fact benefit it by providing 'anchoring' predictors that are independent of climate change.

```{r extract-predictor-data}
# TODO: factor out
bind_extract <- function(x, y) {
  extract <- st_extract(y, st_transform(x, st_crs(y)))
  cbind(x, select(tibble(extract), -geometry))
}

flora <- flora |> 
  mutate(
    occ = map(occ, st_as_sf, coords = c("longitude", "latitude"), crs = latlong, remove = FALSE),
    occ = map(occ, bind_extract, slice(climate, "period", "cur")),
    occ = map(occ, bind_extract, terrain),
    occ = map(occ, bind_extract, soil)
  )
```

## Random Forest

```{r niche-data}
# Split training, test (for model assessment) and cross-validation sets (for
# tuning)
flora <- flora |>
  mutate(
    # De-sf
    occ = map(occ, \(x) select(tibble(x), -geometry)),
    # TODO: can this happen earlier?
    occ = map(occ, \(x) mutate(x, present = factor(present, c(FALSE, TRUE)))),
    occ = map(occ, \(x) mutate(x, weight = importance_weights(weight))),
    # occ = map(occ, \(x) drop_na(x, starts_with("bio"))), # TODO: where do these come from?
    occ_split = map(occ, \(x) initial_split(x, strata = present)),
    # occ_folds = map(occ_split, \(x) vfold_cv(training(x), v = 10, strata = present))
  )

# Data preprocessing recipe
# Following recommended preprocessing steps for RF classification from:
#   https://www.tmwr.org/pre-proc-table.html
niche_recipe <- recipe(training(flora$occ_split[[1]])) |>
  update_role(gbif_key:latitude, new_role = "ID") |>
  update_role(present, new_role = "outcome") |>
  update_role(starts_with("bio"), new_role = "predictor") |>
  update_role(c(elevation, slope, aspect, wetness, clay, phh2o, sand, silt),
              new_role = "predictor") |>
  # Impute missing values based on spatial autocorrelation
  step_impute_linear(all_numeric_predictors(), 
                     impute_with = imp_vars(latitude, longitude)) |>
  # Drop redundant predictors
  step_nzv(all_predictors())
```

Ecological niche modelling is a classification problem that can be approached with a wide range of statistical methods.
A substantial literature exists on the relatively performance of these approaches and their respective parameterisations [reviewed in @ValaviEtAl2022].
Random Forest, a widely-used machine learning algorithm, is amongst the best performing approaches for presence-only species distribution models, providing it is appropriately parameterised to account for the class imbalance between presence and background samples [@ValaviEtAl2021; @ValaviEtAl2022].
For our application, it also has the advantage of requiring little to no manual parameter tuning to achieve good predictive results, which makes it easier to model a larger numbers of taxa.

```{r niche-model}
# Random Forest Niche Model
# With hyperparameters adapted from the example of a down-sampled RF model given 
# by https://rvalavi.github.io/SDMwithRFs/#model-fitting-with-ranger-package
niche_model <- rand_forest(mode = "classification", trees = 1000) |>
  set_engine(
    "ranger", 
    sample.fraction = c(sum(as.logical(.y())) / n_background, 1),
    probability = TRUE
  )

niche_workflow <- workflow(niche_recipe, niche_model)
```

For each taxon we trained a classification model to predict occurrence (presence or absence/background) based on our X<!--TODO--> predictor variables (@tbl-predictors).
We used the Random Forest algorithm implemented in the R package 'ranger' [@WrightZiegler2017] and the 'tidymodels' [@tidymodels] framework for data preprocessing and model selection.
To avoid overfitting, we follow @ValaviEtAl2021 in their recommended hyperparameters and use of down-sampling to balance presence and background samples.
Models for each taxon were fit independently, with redundant zero-variance predictors excluded, and assessed based on balanced training (¾) and test (¼) partitions.

```{r fit-niche-models}
# Fit best model to training data
if (!file_exists(derived_data("flora_niche_fit.Rdata"))) {
  flora <- mutate(
    flora,
    niche = map(occ_split, \(x) last_fit(niche_workflow, x), .progress = TRUE)
  )
  saveRDS(flora, derived_data("flora_niche_fit.Rdata"))
}
flora <- readRDS(derived_data("flora_niche_fit.Rdata"))
```

<!-- TODO: rewrite to remove thresholding -->
The output of the model is probabilistic.
However, this should not be understood as an actual probability of occurrence [@CITE], but more akin to an estimate of habitat suitability.
To simplify interpretation, we can convert these predictions into binary presence/absence maps, a process called "thresholding".
We select the threshold value for each model individually, using MaxSSS [as recommended by @LiuEtAl2013].
This also makes it possible to analyses the predictions together as an assemblage.

# Results

## Model assessment

```{r fig-model-accuracy-vs-n_occ}
#| fig-cap: Number of taxon occurrences and model accuracy on test dataset
flora |>
  mutate(niche_test_fit = map(niche, collect_metrics)) |>
  unnest(niche_test_fit) |>
  filter(.metric == "accuracy") |> # TODO: or roc_auc?
  mutate(label = if_else(.estimate < 0.75, taxon, NA_character_)) |>
  ggplot(aes(n_occ, .estimate)) + 
  geom_smooth(method = "glm", formula = y ~ log(x)) +
  geom_point() + 
  geom_text_repel(aes(label = label), fontface = "italic") +
  scale_x_log10(name = "Occurrences") +
  scale_y_continuous(name = "Model accuracy", labels = label_percent()) +
  theme_half_open() 
```

* Modelled ecological niches on current data

## Hindcasting

Sensitivity to climate fluctuations?

```{r predict}
# NOTE: very high memory usage
if (!file_exists(derived_data("flora_niche_predictions.Rdata"))) {
  flora <- flora |>
    mutate(
      prediction = map(niche, \(mod, obj) predict(obj, extract_fit_engine(mod)),
                       obj = environment, .progress = TRUE)
    )
  saveRDS(flora, derived_data("flora_niche_predictions.Rdata"))
}
flora <- readRDS(derived_data("flora_niche_predictions.Rdata"))
```

```{r fig-niche-prediction, eval=FALSE}
niche_taxon <- "Linum bienne"
niche_prediction <- filter(flora, taxon == niche_taxon)$prediction[[1]]

# Order and relabel periods
ggplot() + 
  facet_wrap(~period, ncol = 3) +
  annotation_spatial(ne_land, fill = "white") +
  geom_stars(data = select(niche_prediction, prediction.TRUE.),
             na.action = na.omit) +
  annotation_spatial(w_asia, fill = NA) +
  scale_fill_batlow(reverse = TRUE) +
  coord_sf(crs = w_asia_albers) +
  labs(
    title = niche_taxon,
    fill = NULL,
    x = NULL,
    y = NULL
  ) +
  theme(
    plot.title = element_text(face = "italic")
  )
```

* Comparison to archaeological occurrences


```{r sum-pred-eh, eval=FALSE}
flora |>
  mutate(pred_eh = map(fit, \(x) predict(climate$EH, model = x, type = "prob"))) ->
  x

pred_eh <- x$pred_eh
names(pred_eh) <- x$taxon
pred_eh <- do.call(c, map(pred_eh, select, .pred_TRUE))
pred_eh <- merge(pred_eh, name = "taxon")
sum_pred_eh <- st_apply(pred_eh, c("x", "y"), sum, na.rm = TRUE)
```

```{r fig-sum-pred-eh, eval=FALSE}
#| fig-cap: predicted species richness for the early Holocene
ggplot() + 
  geom_stars(data = sum_pred_eh) +
  scale_fill_batlow(reverse = FALSE) +
  coord_sf(crs = latlong) +
  labs(
    title = "Predicted species richness",
    subtitle = "Early Holocene (11.7–8.326 ka)",
    fill = NULL,
    x = NULL,
    y = NULL
  )

saveRDS(pred_eh, "pred_eh.Rdata")
```

# Discussion

* General trends:
  * Quantified sensitivity of plant ranges to climate change
  * Crop progenitors saw range contractions just before the onset of agriculture? (Moreso than other wild resources??)
  * How could are reconstructed ranges at predicting archaeological assemblages? (+Implications)
* Interesting individual case studies:
  * Wheat progenitors
  * ???

# Conclusion

# References {.appendix}
