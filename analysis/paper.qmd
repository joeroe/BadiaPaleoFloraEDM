---
title: Biogeography of crop progenitors and wild plant resources during the transition to agriculture in West Asia, 21–8.3 ka
date: today
author: 
- name: Joe Roe
  id: jr
  orcid: 0000-0002-1011-1244
  email: joeroe@hey.com
  affiliations:
    - name: University of Bern
      country: Switzerland
    - name: University of Copenhagen
      country: Denmark
  corresponding: true
- name: Amaia Arranz-Otaegui
  id: aao
  orcid: 0000-0002-5091-6426
  affiliation: 
    - name: University of the Basque Country
      country: Spain
abstract: |
  This paper presents the first comprehensive reconstructions of the 
  palaeodistributions of [X] plant species known to have been gathered or 
  cultivated by early agricultural societies in Southwest Asia, including the 
  progenitors of the first crops. We used machine learning to train an 
  ecological niche model (ENM) of each species based on its present-day 
  distribution in relation to climate and environmental variables. Predictions 
  of the potential ranges of these species at key stages of the 
  Pleistocene–Holocene transition could then be derived from these models using 
  hindcast data from palaeoclimate simulations.
  Species ranges were on average [X%] [larger|smaller] in the Early Holocene 
  compared to today, indicating [...]. The modelled ranges predict the
  observed occurrence of these species on archaeological sites with [low|medium|high]
  accuracy. The regional ubiquity of species in the archaeological record is [not] 
  correlated with the predicted size of its range and the diversity of
  archaeobotanical assemblages is [not] correlated with the predicted diversity
  of its environs. This indicates that trends in taxonomic composition of
  the archaeobotanical record is [not] likely to be influenced by environmental 
  change and species turnover, not just, as is often assumed, human economic 
  choices.
format: 
  elsevier-pdf:
    keep-tex: true
    cite-method: citeproc
    journal:
      name: Open Quaternary
      formatting: review
bibliography: references.bib
execute: 
  echo: false
  eval: false
---

* [ ] Finish analysis:
  - [ ] Add terrain, soil
  - [ ] Find a resolution that's workable
  - [ ] Do thresholding?
- [ ] First draft:
  - [ ] Introduction
  - [ ] Background
    - [ ] Biogeography
    - [ ] ENM
  - [x] Methods & Materials
    - [x] Occurrence data
    - [x] Predictor data
    - [x] Random Forest model
  - [ ] Results
    - [ ] Model assessment
    - [ ] Hindcasting
  - [ ] Discussion
    - [ ] General trends
    - [ ] Case studies
  - [ ] Conclusion
- [ ] Figures
  - [ ] tbl-predictors
  - [ ] tbl-climate-periods
* [ ] Appendix with all hindcast predictions
- [ ] References & copyediting
- [ ] Final proofread

```{r dependencies, eval=TRUE, message=FALSE}
library("cowplot")
library("dplyr")
library("dotenv")
library("english")
library("forcats")
library("fs")
library("furrr")
library("ggplot2")
library("ggrepel")
library("ggspatial")
library("gt")
library("here")
library("khroma")
library("progressr")
library("purrr")
library("ranger")
library("readr")
library("recipes")
library("rgbif")
library("scales")
library("sf")
library("stars")
library("stringr")
library("tibble")
library("tidymodels")
library("tidyr")

library("BadiaPaleoFloraENM") # this package, install with devtools::install()
```

```{r setup-parallel}
# Several parts of this analysis are processing- and memory-intensive.
# You may need to adjust the futures strategy specified here to fit your 
# computational resources. See ?future::plan for options.
plan("multisession")
```

```{r setup-whitebox}
```

```{r define-regions}
latlong <- 4326
utm37n <- 32637

w_asia <- st_bbox(c(xmin = 25, xmax = 55, ymin = 22.5, ymax = 42.5), crs = 4326)
s_levant <- st_bbox(c(xmin = 34, xmax = 39, ymin = 29, ymax = 34), crs = 4326)
```

```{r define-periods, eval=TRUE}
archaeo_periods <- tribble(
  ~period,             ~agriculture,                          ~start_bp, ~end_bp,
  "Late Epipal.",      "Foraging",                            15000,     11700,
  "PPNA",              "Pre-domestication cultivation",       11700,     10700,
  "EPPNB",             "Cultivation of domesticated species", 10700,     10200,
  "MPPNB",             "Cultivation of domesticated species", 10200,     9500,
  "LPPNB/C",           "Agriculture",                         9500,      8500,
  "Pottery Neolithic", "Agriculture",                         8500,      6500,
  "Chalcolithic",      "Agriculture",                         6500,      5000,
)

neolithic <- c("PPNA", "EPPNB", "MPPNB", "LPPNB/C", "Pottery Neolithic")

climate_periods <- fct_inorder(c(
  lgm = "LGM (21 ka)",
  hs1 = "HS1 (17.0-14.7 ka)",
  ba  = "BA (14.7-12.9 ka)",
  yds = "YDS (12.9-11.7 ka)",
  eh  = "EH (11.7-8.3 ka)",
  cur = "current"
))
```

# Introduction

* The first farming societies had an ecological context
* Subsistence is understood (largely) through archaeobotany and zooarchaeology; ecological context from environmental archaeology, palynology, palaeoclimate records, etc.
  * But these have a variety of biases (human selection, taphonomy, etc.)
  * And at the end of the day only represent specific places – interpolation to the entire region is not straightforward
  * Overlap makes it difficult to see where human choices depart from the environmental background [cf. @MartinEtAl2016]
  * Or to fully contextualise subsistence strategies and shifts in strategies in response to environmental shifts [e.g. @YaworskyEtAl2023].
* Here we present an alternative approach using ENM
  * Whole region, at multiple climate snapshots
  * Independent of archaeobot. and pal. clim. data, so can verify and compare

# Background

* The transition to agriculture in West Asia was...

## Biogeography and agricultural origins

* Has always been important in study of agricultural origins
  * Historically: Vavilov, Pumpelly & Childe
  * Genetic studies tell us origin points, but not ranges
* Important to e.g.
  * Distinguish environmental from potentially anthropogenic change [@MartinEtAl2017; @MartinEtAl2025]
  * Reconstruct sequences of domestication [@YeomansEtAl2017]
* Epipal./Neo. plant-based economies were diverse
  * More than the "founder crops"; 
  * More than food
  * (In archaebot., not all intentionally collected)
  * Regionally and temporally diverse
  * ...so we model lots of species!
* Regional ecological reconstructions generally rely on the 'expert interpolation' (or what do they call it with isoscapes?) method
  * See CSEAS (AEA-prep) presentation
  * Figure: comparisons

## Ecological niche modelling in archaeology

<!-- TODO: more citations? -->
Ecological niche modelling (ENM) or species distribution modelling (SDM) is widely used by ecologists to predict the geographic range of a species based on a set of environmental predictors.
Essentially, it involves combining records of where an organism has been observed with environmental data (climate, topography, etc.) for those locations to model the range of environmental values at which that species  – its environmental niche.
This model can then be used to predict the range of the organism in question either in the same or a different environment.
@CITE suggests reserving the term 'species distribution modelling' for when the method is used to recover the verifiable range of a species in a real and existing environment, and using 'ecological niche modelling' as the broader term covering hypothetical or predictive applications – a convention we follow here when referring to predictive or 'hindcast' models of past ranges.
Within this overarching framework, ecological niche modelling encompasses a wide range of applications and a variety of potential environmental predictors, modelling approaches, and methodologies, which we will not attempt to review here.

Ecological niche modelling has long been of interest to archaeologists as both a means of exploring the biological niche of humans and for reconstructing the past environments they inhabited [@DavidPollyEronen2011; @FranklinEtAl2015].
In the first sense, it has been used most extensively to model the range of humans and other hominin species [e.g. @BenitoEtAl2017; @YousefiEtAl2020; @BanksEtAl2021; @YaworskyEtAl2024a; @YaworskyEtAl2024b; @GuranEtAl2024], especially in the Palaeolithic.
This overlaps with what archaeologists usually call generically 'predictive modelling' [@VerhagenWhitley2020]—more precisely 'site distribution modelling'—which is essentially the same approach as (and often borrows methodologies from) ecological niche modelling but applied to the occurrence of archaeological sites.
Here what is modelled is not strictly a biological niche alone, but also aspects of human geography, taphonomy, and archaeological visibility.
These applications can be distinguihed from 'palaeoecological niche modelling', where the object of model remains, as in ecology, a non-human biological niche.

@FranklinEtAl2015 review palaeoecological niche modelling and advocate for its greater adoption in environmental archaeology.
One relevant early example is @ConollyEtAl2012 used the occurrence of wild and domestic *Bos* remains at prehistoric archaeological sites in Europe and West Asia to map the evolving niche of cattle over the Pleistocene–Holocene transition.
It has been used to model the availability of fauna exploited by humans at wider scales [e.g. @deAndresHerreroEtAl2018; @YaworksyEtAl2023] and, in a West Asian context, of foraged plant resources in the landscape around the Neolithic site of XX<!-- TODO: Kortik? --> [@CollinsEtAl2018].
Modelling the spread of crops has been another significant archaeological application [@CremaEtAl].

In the majority of studies to date (palaeo)ecological niche modelling has been applied to archaeological data in an 'inductive' fashion, i.e. faunal and botanical remains from ancient sites are used as the occurrence dataset for training a model using either past or present environmental data.
However, both the zooarchaeological and archaeobotanical records are sparse and subject to a complex array of depositional, taphonomic and recovery biases factors that , many of which are not fully understood and/or cannot be corrected for.
This means that while the archaeological attestation of the presence of a species might generally be relied upon, it is highly unlikely that its absence is representative of true past distributions.

The alternative approach is to train the model using contemporary occurrence and environmental data and then use palaeoenvironmental data to 'hindcast' its predictions backwards in time.
Like @FranklinEtAl2015, we view the hindcasting approach as more promising, because training datasets for both occurrences and environment are far more readily available, complete and reliable for the present than the past.
There is some scepticism in the ecological niche modelling literature about the ability of such models to make accurate predictions in unknown environments (like the past) [@CITES?], 
but here the hindcasting approach also presents an opportunity:
it reserves archaeological occurrence data as an independent dataset that can be used to assess the retrodictive performance of the model.
This possibily was suggested by @FranklinEtAl2015 but to our knowledge our study represents the first attempt to actually do so.

The major practical limitation of the hindcasting approach is that it relies on spatially explicit, high resolution palaeoenvironmental surfaces with continuous coverage of the region and periods of interest.
Until recently, this has not been widely available for most applications, which is perhaps why only a minority of studies use it [cf. @YaworskyEtAl2023].
In this study, we are able to take advantage of the increasing availability of high resolution, global palaeoclimate data derived from simulation experiments with general circulation models of climate [@BrownEtAl2018; @BrownEtAl2020; @KargerEtAl2023].
<!-- TODO: mention that GBIF, CHELSA, SoilGrids, WorldClim, DEMs, etc. are also great? -->

# Methods and materials

```{r read-basemap}
# Turn off s2 while we deal with Natural Earth's dodgy geometries
use_s2 <- sf_use_s2(FALSE)

ne_countries <- read_sf(raw_data("ne"), "ne_10m_admin_0_countries")

ne_lakes <- read_sf(raw_data("ne"), "ne_10m_lakes") |> 
  st_geometry() |>
  st_crop(buffer_bbox(w_asia, 10)) |>
  st_union()

ne_ocean <- read_sf(raw_data("ne"), "ne_10m_ocean") |>
  st_geometry() |>
  st_crop(buffer_bbox(w_asia, 10)) |>
  st_union()

ne_land <- read_sf(raw_data("ne"), "ne_10m_land") |> 
  st_geometry() |>
  st_crop(buffer_bbox(w_asia, 10)) |>
  st_difference(ne_ocean) |>
  st_difference(ne_lakes) |>
  st_union()

s_levant_land <- st_intersection(st_as_sfc(s_levant), ne_land)
w_asia_land <- st_intersection(st_as_sfc(w_asia), ne_land)

# Restore previous setting of s2
sf_use_s2(use_s2)
```

## Occurrence data

```{r data-flora}
# Flora present at archaeological sites
archaeo_flora <- read_tsv(raw_data("swasia_neolithic_flora.tsv")) |>
  rename(taxon_group = "taxon", taxon = "taxon_detail") |>
  # Assign to archaeological periods
  # TODO: refactor as function
  # TODO: assign climate periods too
  mutate(
    age_mid = age_end + ((age_start - age_end) / 2),
    period = cut(-age_mid, 
                 breaks = -c(archaeo_periods$start_bp, 0), 
                 labels = archaeo_periods$period,
                 ordered_result = TRUE)
  ) ->
  archaeo_flora

n_assemb_neolithic <- archaeo_flora |> 
  distinct(site_name, phase_code, period) |> 
  filter(period %in% neolithic) |> 
  nrow()

n_site_neolithic <- archaeo_flora |> 
  filter(period %in% neolithic) |> 
  distinct(site_name) |> 
  nrow()

# Flora to be modelled
archaeo_flora |>
  filter(period %in% neolithic) |>
  group_by(taxon) |>
  summarise(
    n_present = length(unique(phase_code)),
    p_present = n_present / n_assemb_neolithic,
    .groups = "drop"
  ) |>
  filter(n_present > 2) |>
  # Exclude taxa not identified to species
  filter(!str_ends(taxon, "sp.")) ->
  flora
```

We consider X<!-- TODO --> distinct taxa (@tbl-occ-count) - all the identifiable species known to be present at more than three Neolithic sites in West Asia, according to our previous study [@ArranzOtaeguiRoe2023].
<!-- TODO: something about not distinguishing between source of plant remains? -->

```{r data-flora-taxonomy}
# - Normalise species names and match to the GBIF Backbone Taxonomy
# - Recode domesticates as their wild progenitors.
# - Add other wild progenitors of wheats
flora <- flora |>
  mutate(
    taxon = case_match(taxon,
                       "Vicia narbonense" ~ "Vicia narbonensis", # N=3
                       "Triticum aestivocompactum" ~ "Triticum aestivum compactum", # N=3
                       "Heliotropium persicum" ~ "Moltkia angustifolia", # N=2
                       "Lens orientalis" ~ "Vicia orientalis", # N=2
                       "Scirpus tabernaemontani" ~ "Schoenoplectus tabernaemontani", # N=2
                       "Stipa capensis" ~ "Stipa dregeana", # N=2
                       .default = taxon),
    taxon_original = taxon,
    taxon = map_chr(taxon, gbif_accepted_name),
    taxon = case_match(
      taxon,
      "Cicer arietinum" ~ "Cicer reticulatum",
      "Hordeum vulgare" ~ "Hordeum spontaneum",
      "Vicia lens" ~ "Vicia orientalis",
      "Linum usitatissimum" ~ "Linum bienne",
      "Triticum aestivum" ~ "Triticum turgidum dicoccum",
      "Triticum dicoccoides" ~ "Triticum turgidum dicoccum",
      "Triticum turgidum durum" ~ "Triticum turgidum dicoccum",
      "Triticum monococcum" ~ "Triticum monococcum aegilopoides",
      .default = taxon
    )
  ) |>
  bind_rows(tibble(taxon = c("Triticum urartu", "Aegilops speltoides", 
                             "Aegilops tauschii")))
```

Taxonomic names were resolves to the canonical form specified in the GBIF Backbone Taxonomy [@GBIFSecretariat2023].
<!-- TODO: still relevent? aren't we modelling species? -->So for example occurrences for "Bolboschoenus" included all species and subspecies, including specimens described as *Bolboschoenus sp.*, *Bolboschoenus maritimus* and *Scirpus maritimus*.
Domestic species meeting our inclusion criteria were substituted with their wild progenitor(s), where known.

## Occurrence data

```{r data-occ-count}
flora |>
  group_by(taxon) |>
  summarise(
    taxon_original = list(c(taxon_original)),
    n_present = max(n_present), # TODO: be more precise?
    p_present = max(p_present)
    ) |>
  mutate(n_occ = map_dbl(taxon, \(x) occ_count(scientificName = x, 
                                               hasCoordinate = TRUE, 
                                               hasGeospatialIssue = FALSE,
                                               geometry = bbox_wkt(w_asia)))) ->
  flora
```

```{r tbl-occ-count}
#| tbl-cap: "Species modelled in this study."
# TODO: add to caption:
# - with presence in Neolithic sites in West Asia, out of the X sites included in Y
# - with number of reliably-georeferenced occurrences in West Asia recorded in GBIF
# TODO: add count of species included?
flora |>
  mutate(
    taxon_detail = map_chr(taxon_original, paste, collapse = ", "),
    taxon_detail = if_else(taxon == taxon_detail, NA_character_, taxon_detail),
    #include = n_occ > 50
  ) |>
  select(-taxon_original) |>
  # group_by(include) |>
  filter(n_occ > 50) |>
  arrange(-n_present) |>
  gt() |>
  # TODO: move synonyms to footnotes?
  cols_merge(
    c(taxon, taxon_detail),
    rows = !is.na(taxon_detail),
    pattern = "{1}<br><small>(incl. {2})</small>"
  ) |>
  fmt_percent(p_present, decimals = 0) |>
  cols_merge_n_pct(n_present, p_present) |>
  tab_style(cell_text(style = "italic"), cells_body(taxon))
```


```{r filter-flora}
flora <- filter(flora, n_occ > 50)
# Why are there 47k occurrences of Avena sterilis??
flora <- filter(flora, taxon != "Avena sterilis")
```

Occurrence data was obtained from the Global Biodiversity Information Facility (GBIF) using via its application programming interface and the R package rgbif [@ChamberlainBoettiger2017; @rgbif].
Although ENMs have reasonable predictive power even with small training samples [@StockwellPeterson2002; @HernandezEtAl2006; @WiszEtAl2008], we excluded X<!-- TODO --> taxa with less than fifty recorded occurrences in our study region.
We also excluded one taxon (*Avena sterilis*) with over 47,000 occurrences, as this would have been computationally prohibitive and we were uncertain what account for such a disproportionately high number of records.

```{r fetch-occ}
# TODO: Refactor
gbif_data <- function(scientificName, ...) {
  gbif_data <- rgbif::occ_data(scientificName = scientificName, ...)
  gbif_data$data
}

flora |>
  mutate(
    occ = map(taxon, gbif_data, 
              hasCoordinate = TRUE, hasGeospatialIssue = FALSE, 
              geometry = w_asia, limit = 100000,
              .progress = TRUE)
  ) ->
  flora
```

```{r tidy-occ}
# TODO: further tidying. Ideas:
# - https://data-blog.gbif.org/post/gbif-filtering-guide/
# - https://cran.r-project.org/web/packages/CoordinateCleaner/vignettes/Cleaning_GBIF_data_with_CoordinateCleaner.html
# - https://www.r-bloggers.com/2021/03/downloading-and-cleaning-gbif-data-with-r/
flora |>
  mutate(
    occ = map(occ, gbif_drop_imprecise_coords, threshold = 5000),
    occ = map(occ, gbif_drop_fossils),
    occ = map(occ, gbif_drop_duplicate_coords),
    occ = map(occ, gbif_standardise_names),
    occ = map(occ, \(x) {
      select(x, gbif_key = key, scientific_name, genus, species, longitude, 
             latitude)
    })
  ) ->
  flora
```

```{r fig-occ-map}
flora |>
  unnest(occ) |>
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) |>
  ggplot() + 
  facet_wrap(vars(taxon)) +
  layer_spatial(ne_land, fill = "#ffffff") +
  geom_sf(shape = ".") +
  coord_sf(xlim = w_asia[c("xmin", "xmax")], 
           ylim = w_asia[c("ymin", "ymax")],
           crs = utm37n,
           default_crs = latlong)
```

<!-- TODO: occurrence tidying -->

```{r generate-background}
# TODO: maybe defer this to just before the model is actually fit ?
#   (and discard the background sample)
# using a custom recipe step even?
n_background <- 10000

flora <- flora |>
  mutate(
    occ = map(occ, mutate, present = TRUE, weight = 1),
    bg_data = map(occ, function(x, region, n) { 
      background_sample(
        region = region, 
        N = n,
        coord_x = "longitude", coord_y = "latitude",
        present = FALSE,
        weight = (1 / n) * nrow(x) # weight presences and background equally
      )
    }, region = w_asia_land, n = n_background),
    occ = map2(occ, bg_data, bind_rows)
  ) |>
  select(-bg_data)
```

<!-- TODO: fix informal tone -->
Occurrence data only tells us where a species is present;
there is rarely definitive information on where the species is *not* found.
We therefore need to generate random background points or "pseudo-absences" to feed to the model.
There are several ways to do this. 
We follow the advice of @BarbetMassinEtAl2012 for regression-based species distribution models and use a large (:10000) random sample of points, weighted equally against the presences in the regression.
@ValaviEtAl2022 also recommend using a very large background sample for random forest models.

## Predictor data

We modelled the occurrence of species as a function of <!-- TODO -->X spatial predictor variables (@tbl-predictors).
These included:

```{r data-climate}
# Reacquire derived_data/paleoclim if needed:
if (length(dir_ls(derived_data("paleoclim"), glob = "*.tif")) < 1) {
  message("Redownloading Paleoclim data...")
  source(here("data", "data-paleoclim.R"))
}

climate <- read_stars(
  derived_data(
    "paleoclim", 
    paste0("paleoclim_", names(climate_periods), "_2_5m_w_asia.tif")
  ),
  along = NA
)

names(climate) <- names(climate_periods)

climate <- st_redimension(climate, name = "period") |>
  split("band")
```

* Sixteen 'bioclimatic' variables derived from monthly temperature and precipitation values, following standard practice for species distribution models [@HijmansEtAl2005]. Contemporary bioclimatic predictor data for West Asia was extracted from the global CHELSA dataset [@KargerEtAl2017], which predicts temperature and precipitation from downscaled general circulation model output at 1 km resolution.

```{r data-terrain}
# Reacquire derived_data/srtm_15plus_w_asia.tif if needed:
if (!file_exists(derived_data("dem", "srtm_15plus_w_asia.tif"))) {
  message("Redownloading DEM data...")
  source(here("data", "data-dem.R"))
}

# TODO: derived terrain products are two big to commit
# TODO: does TWI actually make sense at this resolution? Could start with (much)
# higher res, then upscale?
terrain <- read_stars(derived_data("dem", c("srtm_15plus_w_asia.tif", 
                                            "srtm_15plus_w_asia_slope.tif",
                                            "srtm_15plus_w_asia_aspect.tif",
                                            "srtm_15plus_w_asia_wetness.tif")))
names(terrain) <- c("elevation", "slope", "aspect", "wetness")
```

* Terrain aspect and slope, which at high resolution perform well as proxies for solar radiation when modelling plant occurrence [@AustinVanNiel2011; @LeempoelEtAl2015]; and the topographic wetness index (TWI), which serves as a proxy for soil moisture and is particularly important in modelling arid environments [@KopeckyCizkova2010; @CamposEtAl2016; @DiVirgilioEtAl2018]. All three were derived from the SRTM15+ digital elevation model using algorithms from WhiteboxTools [@Lindsay2016].

```{r data-soil}
# Reacquire derived_data/soilgrids if needed:
if (length(dir_ls(derived_data("soilgrids"), glob = "*.tif")) < 1) {
  message("Redownloading SoilGrids data...")
  source(here("data", "data-soilgrids.R"))
}

soil <- map(dir_ls(derived_data("soilgrids")), read_stars)
names(soil) <- str_split_i(basename(names(soil)), "_", 2)
soil <- do.call(c, soil)
```

* Edaphic data from SoilGrids [@HenglEtAl2014; @HenglEtAl2017], which improves model performance for plants [@DubuisEtAl2013; @ModEtAl2016; @VelazcoEtAl2017]. Based on a recent assessment of the reliability of SoilGrids data for species distribution modelling [@MillerEtAl2024], we used a subset of four variables relating to soil texture (clay, silt, sand) and pH at the surface (0-5 cm depth).

```{r data-environment}
# For time-invariant predictors, collapse attributes into dimension and 
# duplicate to create a dummy period dimension
# TODO: maybe need to downsample first?
terrain <- st_redimension(terrain, name = "variable")
terrain <- do.call(c, rep(list(terrain), length(climate_periods)))
names(terrain) <- names(climate_periods)
terrain <- st_redimension(terrain, name = "period") # TODO: why *so* slow?

soil <- st_redimension(soil, name = "variable")
soil <- do.call(c, rep(list(soil), length(climate_periods)))
names(soil) <- names(climate_periods)
soil <- st_redimension(soil, name = "period")

# Resample to common grid
terrain <- st_warp(terrain, climate, use_gdal = TRUE, method = "cubicspline")
soil <- st_warp(soil, climate, use_gdal = TRUE, method = "cubicspline")

# TODO: combine and split variable
# TODO: fill NAs?
```

Predictor data was transformed to the same projection system (WGS84 / UTM 37 N) and a common resolution of X<!-- TODO --> km.

For hindcasting, we used reconstructed bioclimatic data for `r english(nrow(climate_periods) - 1)` key periods (@tbl-climate-periods) generated from downscaled paleoclimate simulations from the HadCM3 general circulation model [@BrownEtAl2018].
Terrain and soil predictors were held constant, since reconstructions of these variables in the past are not available at sufficient scale.
It is not likely that either macroscale topography or soil characteristics have altered significantly over the period of time considered here, so we assume that this does not degrade model performance, and may in fact benefit it by providing 'anchoring' predictors that are independent of climate change.

```{r extract-predictor-data}
flora |> 
  mutate(
    occ = map(occ, \(x) cbind(x, st_extract(climate$cur, gbif_to_sf(x)))),
    # TODO: where is the extra geometry column coming from?
    occ = map(occ, \(x) as_tibble(select(x, -geometry))),
    # TODO: can this happen earlier?
    occ = map(occ, \(x) mutate(x, present = factor(present, c(FALSE, TRUE))))
  ) ->
  flora
```

## Random Forest

```{r niche-data}
# Split training, test (for model assessment) and cross-validation sets (for
# tuning)
flora <- flora |>
  mutate(
    occ = map(occ, \(x) mutate(x, weight = importance_weights(weight))),
    occ = map(occ, \(x) drop_na(x, starts_with("bio"))), # TODO: where do these come from?
    occ_split = map(occ, \(x) initial_split(x, strata = present)),
    # occ_folds = map(occ_split, \(x) vfold_cv(training(x), v = 10, strata = present))
  )

# Data preprocessing recipe
# Following recommended preprocessing steps for RF classification from:
#   https://www.tmwr.org/pre-proc-table.html
niche_recipe <- recipe(training(flora$occ_split[[1]])) |>
  update_role(gbif_key:latitude, new_role = "ID") |>
  update_role(present, new_role = "outcome") |>
  update_role(starts_with("bio"), new_role = "predictor") |>
  step_nzv(all_predictors())
```

Ecological niche modelling is a classification problem that can be approached with a wide range of statistical methods.
A substantial literature exists on the relatively performance of these approaches and their respective parameterisations [reviewed in @ValaviEtAl2022].
Random Forest, a widely-used machine learning algorithm, is amongst the best performing approaches for presence-only species distribution models, providing it is appropriately parameterised to account for the class imbalance between presence and background samples [@ValaviEtAl2021; @ValaviEtAl2022].
For our application, it also has the advantage of requiring little to no manual parameter tuning to achieve good predictive results, which makes it easier to model a larger numbers of taxa.

```{r niche-model}
# Random Forest Niche Model
# With hyperparameters adapted from the example of a down-sampled RF model given 
# by https://rvalavi.github.io/SDMwithRFs/#model-fitting-with-ranger-package
niche_model <- rand_forest(mode = "classification", trees = 1000) |>
  set_engine(
    "ranger", 
    sample.fraction = c(sum(as.logical(.y())) / n_background, 1),
    probability = TRUE
  )

# TODO: Or... tune parameters? But this is very compute-intensive.
# niche_model <- rand_forest(
#   mode = "classification", 
#   mtry = tune(),
#   trees = tune(),
#   min_n = tune()
# ) |>
#   set_engine("ranger", probability = TRUE)

niche_workflow <- workflow(niche_recipe, niche_model)

# Tune model (separately for each taxon)
# TODO: questioning - would be nice but is extremely slow
# flora |>
#   slice_sample(n = 10) |>
#   mutate(
#     niche_tuning_grid = map(occ_split, function(data, recipe) {
#       grid_regular(
#         finalize(mtry(), bake(prep(recipe), training(data), all_predictors())),
#         trees(),
#         min_n(),
#         levels = 5
#       )
#     }, recipe = niche_recipe, .progress = TRUE),
#     niche_tuning = map2(niche_tuning_grid, occ_folds, function(grid, folds, wflow) {
#       tune_grid(wflow, folds, grid = grid)
#     }, wflow = niche_workflow, .progress = TRUE),
#     niche_hparams = map(niche_tuning, select_best, metric = "roc_auc"),
#     niche_model = map(niche_hparams, function(params, wflow) {
#       finalize_workflow(wflow, params)
#     }, wflow = niche_workflow)
#   )
```

For each taxon we trained a classification model to predict occurrence (presence or absence/background) based on our X<!--TODO--> predictor variables (@tbl-predictors).
We used the Random Forest algorithm implemented in the R package 'ranger' [@WrightZiegler2017] and the 'tidymodels' [@tidymodels] framework for data preprocessing and model selection.
To avoid overfitting, we follow @ValaviEtAl2021 in their recommended hyperparameters and use of down-sampling to balance presence and background samples.
Models for each taxon were fit independently, with redundant zero-variance predictors excluded, and assessed based on balanced training (3/4) and test (1/4) partitions.

<!-- TODO: OR:
Hyperparameter tuning is important to avoid over-fitting [@CITE].
We tuned each model separately to maximise ROC AUC.
-->

```{r fit-niche-models}
# Fit best model to training data
flora <- flora |>
  mutate(
    niche = map(occ_split, \(x) last_fit(niche_workflow, x), .progress = TRUE)
  )
```

<!-- TODO: cut? -->
The output of the model is probabilistic.
However, this should not be understood as an actual probability of occurrence [@CITE], but more akin to an estimate of habitat suitability.
To simplify interpretation, we can convert these predictions into binary presence/absence maps, a process called "thresholding".
We select the threshold value for each model individually, using MaxSSS [as recommended by @LiuEtAl2013].
This also makes it possible to analyses the predictions together as an assemblage.

```{r thresholding}
# TODO: thresholding?
# - Pick a threshold
# - Reclassify pred raster
# - Extract predicted classification (for cur) for occ
# - ...or predict back onto the occurrence data? do we actually need the rasters for this?
# - Calculate sensitivity and with yardstick
# - Sum (SSS)
# - (Plot?)
# - Pick max SSS
#
# Or just stick with probabilities?
```

# Results

## Model assessment

```{r fig-model-accuracy-vs-n_occ}
#| fig-cap: Number of taxon occurrences and model accuracy on test dataset
flora |>
  mutate(niche_test_fit = map(niche, collect_metrics)) |>
  unnest(niche_test_fit) |>
  filter(.metric == "accuracy") |> # TODO: or roc_auc?
  mutate(label = if_else(.estimate < 0.8, taxon, NA_character_)) |>
  ggplot(aes(n_occ, .estimate)) + 
  geom_smooth(method = "glm", formula = y ~ log(x)) +
  geom_point() + 
  geom_text_repel(aes(label = label), fontface = "italic") +
  scale_x_log10(name = "Occurrences") +
  scale_y_continuous(name = "Model accuracy", labels = label_percent()) +
  theme_half_open() 
```

* Modelled ecological niches on current data

## Hindcasting

Sensitivity to climate fluctuations?

```{r predict}
# TODO: structure this way from the beginning?
# Thanks to https://stackoverflow.com/questions/65183306/stars-package-how-to-define-additional-dimensions-based-on-an-attribute-filena
climate_pred <- do.call(c, map(climate, st_redimension, name = "variable")) |>
  st_redimension(name = "period") |>
  split("variable")

# NOTE: very high memory usage
flora <- flora |>
  mutate(
    prediction = map(niche, \(mod, obj) predict(obj, extract_fit_engine(mod)), 
                     obj = climate_pred)
  )
```

```{r fig-niche-prediction}
niche_prediction <- filter(flora, taxon == "Linum bienne")$prediction[[1]]

# Order and relabel periods
climate_periods <- niche_prediction |>
  st_get_dimension_values("period") |>
  ordered(levels = c("LGM", "HS1", "BA", "YDS", "EH", "cur")) |>
  recode(
    "LGM" = "LGM (21 ka)",
    "HS1" = "HS1 (17.0-14.7 ka)",
    "BA"  = "BA (14.7-12.9 ka)",
    "YDS" = "YDS (12.9-11.7 ka)",
    "EH"  = "EH (11.7-8.3 ka)",
    "cur" = "current"
  )

niche_prediction <- st_set_dimensions(niche_prediction, "period", values = climate_periods)

ggplot() + 
  geom_stars(data = select(niche_prediction, prediction.TRUE.) > 0.5) +
  facet_wrap(~period, ncol = 3) +
  # scale_fill_batlow(reverse = TRUE) +
  coord_sf(crs = latlong) +
  labs(
    title = "Linum bienne",
    fill = NULL,
    x = NULL,
    y = NULL
  ) +
  theme_map() +
  theme(
    plot.title = element_text(face = "italic")
  )
```

* Comparison to archaeological occurrences


```{r sum-pred-eh}
flora |>
  mutate(pred_eh = map(fit, \(x) predict(climate$EH, model = x, type = "prob"))) ->
  x

pred_eh <- x$pred_eh
names(pred_eh) <- x$taxon
pred_eh <- do.call(c, map(pred_eh, select, .pred_TRUE))
pred_eh <- merge(pred_eh, name = "taxon")
sum_pred_eh <- st_apply(pred_eh, c("x", "y"), sum, na.rm = TRUE)
```

```{r fig-sum-pred-eh}
#| fig-cap: predicted species richness for the early Holocene
ggplot() + 
  geom_stars(data = sum_pred_eh) +
  scale_fill_batlow(reverse = FALSE) +
  coord_sf(crs = latlong) +
  labs(
    title = "Predicted species richness",
    subtitle = "Early Holocene (11.7–8.326 ka)",
    fill = NULL,
    x = NULL,
    y = NULL
  )

saveRDS(pred_eh, "pred_eh.Rdata")
```

# Discussion

* General trends:
  * Quantified sensitivity of plant ranges to climate change
  * Crop progenitors saw range contractions just before the onset of agriculture? (Moreso than other wild resources??)
  * How could are reconstructed ranges at predicting archaeological assemblages? (+Implications)
* Interesting individual case studies:
  * Wheat progenitors
  * ???

```{r fig-pred-observed-eh}

```

# Conclusion

# References {.appendix}
