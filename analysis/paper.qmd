---
title: Biogeography of crop progenitors and wild plant resources in the terminal Pleistocene and Early Holocene of West Asia, 14.7–8.3 ka
date: today
author: 
- name: Joe Roe
  id: jr
  orcid: 0000-0002-1011-1244
  email: joeroe@hey.com
  affiliations:
    - name: University of Bern
      country: Switzerland
    - name: University of Copenhagen
      country: Denmark
  corresponding: true
- name: Amaia Arranz-Otaegui
  id: aao
  orcid: 0000-0002-5091-6426
  affiliation: 
    - name: University of the Basque Country
      country: Spain
abstract: |
  This paper presents the first continuous, spatially-explicit reconstructions 
  of the palaeodistributions of 56 plant species found regularly in association 
  with early agricultural archaeological sites in West Asia, including the 
  progenitors of the first crops. We used machine learning to train an 
  ecological niche model of each species based on its present-day distribution 
  in relation to climate and environmental variables. Predictions of the 
  potential ranges of these species at key stages of the Pleistocene–Holocene 
  transition could then be derived from these models using downsampled data from 
  palaeoclimate simulations.
  Species ranges are predicted to have been on significantly smaller in the 
  Early Holocene compared to present conditions, with many species that are 
  found throughout the region's 'hilly flanks' today indicated to have much more
  restricted distributions centered on the Levant, Cyprus and Western Anatolia. 
  Ranges shrunk by on average c. 10% from the terminal Pleistocene to the Early 
  Holocene, with a further c. 10% reduction for the duration of the Younger 
  Dryas. However, modelled ranges do not reliably predict the observed 
  occurrence of specific species at archaeological sites. [...]
  The regional 
  ubiquity of species in the archaeological record is [not] correlated with the 
  predicted size of its range and the diversity of archaeobotanical assemblages is [not] 
  correlated with the predicted diversity of its environs. This indicates that 
  trends in taxonomic composition of the archaeobotanical record is [not] likely 
  to have been influenced by environmental change and species turnover, in
  addition to human economic choices.
format: 
  elsevier-pdf:
    keep-tex: true
    # cite-method: citeproc
    journal:
      name: Open Quaternary
      formatting: preprint
      cite-style: authoryear
bibliography: references.bib
execute: 
  echo: false
---

* [x] Stop modelling
- [ ] First draft:
  - [x] Introduction
  - [ ] Background
    - [ ] Biogeography
    - [x] ENM
  - [x] Methods & Materials
  - [x] Results
  - [ ] Discussion
    - [x] General trends
    - [ ] Case studies
    - [x] Comparison with archaeobot
  - [ ] Conclusion
- [ ] Figures
  - [x] fig-region
  - [x] fig-occ
  - [ ] tbl-occ-count (needs pdf cleanup)
  - [ ] tbl-predictors
  - [ ] tbl-model-metrics
- [ ] Outstanding TODOs
- [ ] Add missing references
- [ ] Copyedit
- [ ] Appendix with all hindcast predictions (HTML?)
- [ ] Clean up package code
- [ ] Final proofread

```{r dependencies, message=FALSE}
library("cowplot")
library("dplyr")
library("dotenv")
library("english")
library("forcats")
library("fs")
library("furrr")
library("ggplot2")
library("ggrepel")
library("ggspatial")
library("gt")
library("here")
library("khroma")
library("progressr")
library("purrr")
library("ranger")
library("readr")
library("recipes")
library("rgbif")
library("scales")
library("sf")
library("stars")
library("stringr")
library("tibble")
library("tidymodels")
library("tidyr")

library("BadiaPaleoFloraENM") # this package, install with devtools::install()
```

```{r setup-parallel}
# Several parts of this analysis are processing- and memory-intensive.
# You may need to adjust the futures strategy specified here to fit your 
# computational resources. See ?future::plan for options.
plan("multisession")
```

```{r define-regions}
latlong <- 4326
w_asia_albers <- "+proj=aea +lat_1=22.5 +lat_2=42.5 +lon_0=40"

w_asia <- st_bbox(c(xmin = 25, xmax = 55, ymin = 22.5, ymax = 42.5), crs = 4326)

levant <- st_bbox(c(xmin = 33, xmax = 39, ymin = 30, ymax = 38))
s_levant <- st_bbox(c(xmin = 34, xmax = 39, ymin = 29, ymax = 34), crs = 4326)
```

```{r define-periods}
archaeo_periods <- tribble(
  ~period,             ~agriculture,                          ~start_bp, ~end_bp,
  "Late Epipal.",      "Foraging",                            15000,     11700,
  "PPNA",              "Pre-domestication cultivation",       11700,     10700,
  "EPPNB",             "Cultivation of domesticated species", 10700,     10200,
  "MPPNB",             "Cultivation of domesticated species", 10200,     9500,
  "LPPNB/C",           "Agriculture",                         9500,      8500,
  "Pottery Neolithic", "Agriculture",                         8500,      6500,
  "Chalcolithic",      "Agriculture",                         6500,      5000,
)

neolithic <- c("PPNA", "EPPNB", "MPPNB", "LPPNB/C", "Pottery Neolithic")

climate_periods <- tibble(
  period = c("Bølling-Allerød", "Younger Dryas", "Early Holocene", "Current"),
  code = c("ba", "yds", "eh", "cur"),
  label = fct_inorder(c("BA (14.7-12.9 ka)", "YDS (12.9-11.7 ka)", 
                      "EH (11.7-8.3 ka)", "current")),
  start_bp = c(14700, 12900, 11700, NA),
  end_bp = c(12900, 11700, 8300, NA)
)
```

```{r define-parameters}
# Minimum number of GBIF occurrences for modelling
min_n_occ <- 50

# Number of background samples per taxon
n_background <- 10000

# Raster resolution for prediction (meters)
pred_res <- 5000
```

# Introduction

The Pleistocene–Holocene transition in West Asia marked a turning point in global environmental history, as humans brought the first plants under cultivation and began modifying surrounding ecosystems to support their own subsistence.
West Asia is part of the native range of a remarkable number of domesticable plant species, including wild relatives of wheat, barley, peas, lentils, and other crops of global importance [@cite].
Even before the end of the Ice Age, these species supported uniquely dense and complex Late Epipalaeolithic (15–11.7 ka) societies based on intensive foraging [@cite] and eventually pre-domestication cultivation [@cite].
As they were brought under domestication in the Pre-Pottery Neolithic period (11.7–8.5 ka), the world's first agriculture was shaped by the ecosystems from which it emerged and was embedded in.

Decades of research in archaeobotany and zooarchaeology have reconstructed the subsistence economies of Late Epipalaeolithic and Neolithic sites in great detail [@cites].
Together with studies of charcoal [@cite], pollen [@cite], soil [@cite], and a variety of palaeoclimate archives [@JonesEtAl2019], they also tell us much about the environments surrounding these settlements.
However, each of these sources of evidence is subject to the wide variety of taphonomic and recovery biases that are inherent in any direct record of the past.
They are also, by definition, records of the (human) environment at particular times and places.
Interpolating these snapshots to give a holistic picture of the regional ecologies is not straightforward – to date, it has tended to rely on non-explicit, inductive modelling.
The majority are also filtered through human action, producing a mixed single that makes it difficult to disentangle anthropic effects from the background of environmental change in this period of rapid climatic alteration.

In this paper we present a complementary, deductive approach based on ecological niche modelling.
Rather than inferring environmental conditions from preserved physical evidence, 
we predict the ranges of individual species relevant to human subsistence based on a model of their current environmental niche and simulations of past palaeoclimate. 
Though hypothetical, this gives us an independent line of evidence on past ecologies that is independent of the environmental archaeological and palaeoclimatic records.
<!-- TODO which we can use to ... --->
Our computational approach is also readily scaled up, allowing us to model spatially-explicit palaeodistributions for a large number of species, for the whole region, under multiple past climatologies.

# Background

* The transition to agriculture in West Asia was...

## Biogeography and agricultural origins

* Has always been important in study of agricultural origins
  * Historically: Vavilov, Pumpelly & Childe
  * Genetic studies tell us origin points, but not ranges
* Important to e.g.
  * Distinguish environmental from potentially anthropogenic change [@MartinEtAl2016; @MartinEtAl2025]
  * Reconstruct sequences of domestication [@YeomansEtAl2017]
* Epipal./Neo. plant-based economies were diverse
  * More than the "founder crops"; 
  * More than food
  * (In archaebot., not all intentionally collected)
  * Geographically and temporally diverse
  * ...so we model lots of species!
* Regional ecological reconstructions generally rely on the 'expert interpolation' (or what do they call it with isoscapes?) method
  * See CSEAS (AEA-prep) presentation
  * Figure: comparisons

## Ecological niche modelling in archaeology

<!-- TODO: more citations? -->
Ecological niche modelling (ENM) or species distribution modelling (SDM) is widely used by ecologists to predict the geographic range of a species based on a set of environmental predictors.
Essentially, it involves combining records of where an organism has been observed with environmental data (climate, topography, etc.) for those locations to model the range of environmental values at which that species  – its environmental niche.
This model can then be used to predict the range of the organism in question either in the same or a different environment.
@CITE suggests reserving the term 'species distribution modelling' for when the method is used to recover the verifiable range of a species in a real and existing environment, and using 'ecological niche modelling' as the broader term covering hypothetical or predictive applications – a convention we follow here when referring to predictive or 'hindcast' models of past ranges.
Within this overarching framework, ecological niche modelling encompasses a wide range of applications and a variety of potential environmental predictors, modelling approaches, and methodologies, which we will not attempt to review here.

Ecological niche modelling has long been of interest to archaeologists as both a means of exploring the biological niche of humans and for reconstructing the past environments they inhabited [@DavidPollyEronen2011; @FranklinEtAl2015].
In the first sense, it has been used most extensively to model the range of humans and other hominin species [e.g. @BenitoEtAl2017; @YousefiEtAl2020; @BanksEtAl2021; @YaworskyEtAl2024a; @YaworskyEtAl2024b; @GuranEtAl2024], especially in the Palaeolithic.
This overlaps with what archaeologists usually call generically 'predictive modelling' [@VerhagenWhitley2020]—more precisely 'site distribution modelling'—which is essentially the same approach as (and often borrows methodologies from) ecological niche modelling but applied to the occurrence of archaeological sites.
Here what is modelled is not strictly a biological niche alone, but also aspects of human geography, taphonomy, and archaeological visibility.
These applications can be distinguihed from 'palaeoecological niche modelling', where the object of model remains, as in ecology, a non-human biological niche.

@FranklinEtAl2015 review palaeoecological niche modelling and advocate for its greater adoption in environmental archaeology.
In an early application to West Asia, @ConollyEtAl2012 used the occurrence of wild and domestic *Bos* remains at prehistoric archaeological sites to map the evolving niche of cattle over the Pleistocene–Holocene transition.
It has been used to model the availability of fauna exploited by humans at wider scales [e.g. @deAndresHerreroEtAl2018; @YaworskyEtAl2023] and, in a West Asian context, of foraged plant resources in the landscape around the Neolithic site of XX<!-- TODO: Kortik? --> [@CollinsEtAl2018].
Modelling the spread of crops has been another significant archaeological application [@CremaEtAl].

In the majority of studies to date (palaeo)ecological niche modelling has been applied to archaeological data in an 'inductive' fashion, i.e. faunal and botanical remains from ancient sites are used as the occurrence dataset for training a model using either past or present environmental data.
However, both the zooarchaeological and archaeobotanical records are sparse and subject to a complex array of depositional, taphonomic and recovery biases factors that , many of which are not fully understood and/or cannot be corrected for.
This means that while the archaeological attestation of the presence of a species might generally be relied upon, it is highly unlikely that its absence is representative of true past distributions.

The alternative approach is to train the model using contemporary occurrence and environmental data and then use palaeoenvironmental data to 'hindcast' its predictions backwards in time.
Like @FranklinEtAl2015, we view the hindcasting approach as more promising, because training datasets for both occurrences and environment are far more readily available, complete and reliable for the present than the past.
There is some scepticism in the ecological niche modelling literature about the ability of such models to make accurate predictions in unknown environments (like the past) [@CITES?], 
but here the hindcasting approach also presents an opportunity:
it reserves archaeological occurrence data as an independent dataset that can be used to assess the retrodictive performance of the model.
This possibily was suggested by @FranklinEtAl2015 but to our knowledge our study represents the first attempt to actually do so.

The major practical limitation of the hindcasting approach is that it relies on spatially explicit, high resolution palaeoenvironmental surfaces with continuous coverage of the region and periods of interest.
Until recently, this has not been widely available for most applications, which is perhaps why only a minority of studies use it [cf. @YaworskyEtAl2023].
In this study, we are able to take advantage of the increasing availability of high resolution, global palaeoclimate data derived from simulation experiments with general circulation models of climate [@BrownEtAl2018; @BrownEtAl2020; @KargerEtAl2023].
<!-- TODO: mention that GBIF, CHELSA, SoilGrids, WorldClim, DEMs, etc. are also great? -->

# Data and model

```{r data-basemap, message=FALSE}
# Turn off s2 while we deal with Natural Earth's dodgy geometries
use_s2 <- sf_use_s2(FALSE)

ne_countries <- read_sf(raw_data("ne"), "ne_10m_admin_0_countries")

ne_rivers <- read_sf(raw_data("ne"), "ne_10m_rivers_lake_centerlines_scale_rank")

ne_lakes <- read_sf(raw_data("ne"), "ne_10m_lakes") |> 
  st_geometry() |>
  st_crop(buffer_bbox(w_asia, 10)) |>
  st_union()

ne_ocean <- read_sf(raw_data("ne"), "ne_10m_ocean") |>
  st_geometry() |>
  st_crop(buffer_bbox(w_asia, 10)) |>
  st_union()

ne_land <- read_sf(raw_data("ne"), "ne_10m_land") |> 
  st_geometry() |>
  st_crop(buffer_bbox(w_asia, 10)) |>
  st_difference(ne_ocean) |>
  # st_difference(ne_lakes) |>
  st_union()

s_levant_land <- st_intersection(st_as_sfc(s_levant), ne_land)
w_asia_land <- st_intersection(st_as_sfc(w_asia), ne_land)

# Restore previous setting of s2
sf_use_s2(use_s2)
```

```{r data-archaeo-flora}
# Flora present at archaeological sites
archaeo_flora <- read_tsv(
  raw_data("swasia_neolithic_flora.tsv"),
  col_types = cols(
    source = col_character(),
    source_id = col_character(),
    source_site_name = col_character(),
    site_name = col_character(),
    latitude = col_double(),
    longitude = col_double(),
    phase = col_character(),
    phase_description = col_character(),
    phase_code = col_character(),
    age_start = col_integer(),
    age_end = col_integer(),
    taxon_source = col_character(),
    n = col_double(),
    prop = col_double(),
    reference = col_character(),
    taxon_detail = col_character(),
    taxon = col_character(),
    genus = col_character(),
    family = col_character(),
    category = col_character(),
    founder_crop = col_character(),
    edibility = col_character(),
    grass_type = col_character(),
    legume_type = col_character()
  )
) |>
  rename(taxon_group = "taxon", taxon = "taxon_detail") |>
  # Assign to archaeological periods
  mutate(
    age_mid = age_end + ((age_start - age_end) / 2),
    period = cut(
      -age_mid, 
      breaks = -c(archaeo_periods$start_bp, 0), 
      labels = archaeo_periods$period,
      ordered_result = TRUE
    ),
    climate_period = cut(
      -age_mid, 
      breaks = -c(climate_periods[climate_periods$code != "cur",]$start_bp, 0), 
      labels = climate_periods[climate_periods$code != "cur",]$code,
      ordered_result = TRUE
    )
  ) ->
  archaeo_flora

n_assemb_neolithic <- archaeo_flora |> 
  distinct(site_name, phase_code, period) |> 
  filter(period %in% neolithic) |> 
  nrow()

n_site_neolithic <- archaeo_flora |> 
  filter(period %in% neolithic) |> 
  distinct(site_name) |> 
  nrow()
```

```{r data-archaeo-sites}
archaeo_sites <- summarise(
  archaeo_flora, 
  latitude = first(latitude), 
  longitude = first(longitude), 
  .by = c(site_name, period)
) |>
  st_as_sf(coords = c("longitude", "latitude"), crs = latlong, remove = FALSE)
```

```{r fig-region}
#| fig-cap: Study region (red) and archaeological sites used to generate modelled flora. Solid circles indicate Neolithic sites.
ggplot() + 
  annotation_spatial(ne_land, fill = "#ffffff") +
  annotation_spatial(ne_rivers, aes(linewidth = strokeweig), colour = "lightblue") +
  layer_spatial(w_asia, colour = "red", fill = NA) +
  layer_spatial(archaeo_sites, shape = 1) +
  layer_spatial(filter(archaeo_sites, period %in% neolithic), shape = 16) +
  scale_linewidth_identity() +
  coord_sf(crs = w_asia_albers)
```

<!-- TODO define study region and period -->

```{r data-flora}
if (!file_exists(derived_data("flora.tsv"))) {
  message("Regenerating flora...")
  # Subset of flora to be modelled
  archaeo_flora |>
    filter(period %in% neolithic) |>
    group_by(taxon) |>
    summarise(
      n_present = length(unique(phase_code)),
      p_present = n_present / n_assemb_neolithic,
      .groups = "drop"
    ) |>
    filter(n_present > 2) |>
    # Exclude taxa not identified to species
    filter(!str_ends(taxon, "sp.")) ->
    flora
  
  # Standardise taxonomy
  flora <- flora |>
    # Normalise species names and match to the GBIF Backbone Taxonomy
    mutate(
      taxon = case_match(taxon,
                         "Vicia narbonense" ~ "Vicia narbonensis", # N=3
                         "Triticum aestivocompactum" ~ "Triticum aestivum compactum", # N=3
                         "Heliotropium persicum" ~ "Moltkia angustifolia", # N=2
                         "Lens orientalis" ~ "Vicia orientalis", # N=2
                         "Scirpus tabernaemontani" ~ "Schoenoplectus tabernaemontani", # N=2
                         "Stipa capensis" ~ "Stipa dregeana", # N=2
                         .default = taxon),
      taxon_original = taxon,
      taxon = map_chr(taxon, gbif_accepted_name)
    ) |>
    # Recode domesticates as their wild progenitors.
    mutate(
      taxon = case_match(
        taxon,
        "Cicer arietinum" ~ "Cicer reticulatum",
        "Hordeum vulgare" ~ "Hordeum spontaneum",
        "Vicia lens" ~ "Vicia orientalis",
        "Linum usitatissimum" ~ "Linum bienne",
        "Triticum aestivum" ~ "Triticum turgidum dicoccum",
        "Triticum dicoccoides" ~ "Triticum turgidum dicoccum",
        "Triticum turgidum durum" ~ "Triticum turgidum dicoccum",
        "Triticum monococcum" ~ "Triticum monococcum aegilopoides",
        .default = taxon
      )
    ) |>
    # Add wild progenitors of wheats
    bind_rows(
      tibble(
        taxon = c("Triticum urartu", "Aegilops speltoides", "Aegilops tauschii"),
        taxon_original = c("Triticum urartu", "Aegilops speltoides", "Aegilops tauschii")
      )
    ) |>
    # Deduplicate by canonical taxon
    summarise(
      taxon_detail = paste0("*", taxon_original[taxon_original != taxon], "*", collapse = ", "),
      taxon_detail = na_if(taxon_detail, "**"),
      n_present = max(n_present),
      p_present = max(p_present),
      .by = taxon
    )
  
  write_tsv(flora, derived_data("flora.tsv"))
}

flora <- read_tsv(
  derived_data("flora.tsv"),
  col_types = cols(
    taxon = col_character(),
    taxon_detail = col_character(),
    n_present = col_double(),
    p_present = col_double()
  )
)
```

We began by considering `r nrow(flora)` distinct taxa (@tbl-occ-count) - all the identifiable species known to be present at more than three Neolithic (c. 11.7–6.5 ka) sites in West Asia, according to our previous study of the regional archaeobotanical data [@ArranzOtaeguiRoe2023].
<!-- TODO: something about not distinguishing between source of plant remains? -->
Taxonomic names were resolved to the canonical form specified in the GBIF Backbone Taxonomy [@GBIFSecretariat2023].
So for example occurrences for *Bolboschoenus maritimus* also include those recorded under the older nomenclature *Scirpus maritimus* (see @tbl-occ-count).
Domestic species meeting our inclusion criteria were substituted with their wild progenitor(s), where different.

## Occurrence data

```{r data-occ-count}
if (!file_exists(derived_data("flora_occ_count.tsv"))) {
  message("Reacquiring GBIF occurrence counts...")
  flora <- flora |>
    mutate(
      n_occ = map_dbl(taxon, \(x) occ_count(scientificName = x, 
                                            hasCoordinate = TRUE, 
                                            hasGeospatialIssue = FALSE,
                                            geometry = bbox_wkt(w_asia)))
    )
  write_tsv(flora, derived_data("flora_occ_count.tsv"))
}
flora <- read_tsv(
  derived_data("flora_occ_count.tsv"),
  col_types = cols(
    taxon = col_character(),
    taxon_detail = col_character(),
    n_present = col_double(),
    p_present = col_double(),
    n_occ = col_double()
  )
)
```

```{r tbl-occ-count}
#| tbl-cap: "Recorded occurrence of flora considered in this study in Neolithic and contemporary West Asia"
flora |>
  mutate(
    exclude = (n_occ < min_n_occ) | (taxon == "Avena sterilis"),
    label = if_else(
      !is.na(taxon_detail),
      glue::glue("*{taxon}*\n\n<small>incl. {taxon_detail}</small>"),
      paste0("*", taxon, "*")
    )
  ) |>
  select(label, n_present, p_present, n_occ, exclude) |>
  arrange(-n_present) |>
  gt() |>
  cols_label(
    label = "Taxon",
    n_present = "Neolithic",
    p_present = "(%)",
    n_occ = "Present"
  ) |>
  tab_spanner("Occurrences", columns = c(n_present, p_present, n_occ)) |>
  # cols_merge_n_pct(n_present, p_present) |>
  cols_hide(exclude) |>
  tab_footnote(
    "Excluded from modelling due to sample size", 
    cells_body(columns = c(n_occ), rows = exclude),
    placement = "right"
  ) |>
  cols_align("left", c(label)) |>
  cols_align("right", c(n_present, p_present, n_occ)) |>
  cols_width(label ~ pct(50), n_present ~ 10, p_present ~ 10, n_occ ~ 20) |>
  fmt_percent(p_present, decimals = 0) |>
  fmt_markdown(label) |>
  sub_missing() |>
  tab_options(
    footnotes.marks = "*",
    table.font.size = 11,
    table.width = pct(100),
    latex.use_longtable = TRUE
  )
```

Georeferenced occurrence data was obtained from the Global Biodiversity Information Facility (GBIF) using via its application programming interface and the R package 'rgbif' [@ChamberlainBoettiger2017; @rgbif].
GBIF occurrences marked has having imprecise or duplicate coordinates were excluded from the training dataset, as were fossil records.
Although niche models have reasonable predictive power even with small training samples [@StockwellPeterson2002; @HernandezEtAl2006; @WiszEtAl2008], we excluded `r english(nrow(filter(flora, n_occ > min_n_occ)))` taxa with less than `r min_n_occ` occurrences in West Asia, following recommendations for niche models generally and Random Forest-based models specifically [@StockwellPeterson2002; @LuanEtAl2020].
We also excluded one taxon (*Avena sterilis*) with over 50,000 occurrences, as this would have been computationally prohibitive and we were uncertain what account for such a disproportionately high number of records.

```{r data-filter-flora}
flora <- filter(flora, n_occ > min_n_occ)
# Why are there 50k occurrences of Avena sterilis??
flora <- filter(flora, taxon != "Avena sterilis")
```

```{r data-occ}
# TODO: further tidying. Ideas:
# - https://data-blog.gbif.org/post/gbif-filtering-guide/
# - https://cran.r-project.org/web/packages/CoordinateCleaner/vignettes/Cleaning_GBIF_data_with_CoordinateCleaner.html
# - https://www.r-bloggers.com/2021/03/downloading-and-cleaning-gbif-data-with-r/
if (!file_exists(derived_data("flora_occ.tsv"))) {
  message("Reacquiring GBIF occurrences...")
  flora <- mutate(
    flora,
    occ = map(
      taxon, gbif_data, 
      hasCoordinate = TRUE, hasGeospatialIssue = FALSE, geometry = w_asia, 
      limit = 100000, .progress = TRUE
    ),
    occ = map(occ, gbif_drop_imprecise_coords, threshold = 5000),
    occ = map(occ, gbif_drop_fossils),
    occ = map(occ, gbif_drop_duplicate_coords),
    occ = map(occ, gbif_standardise_names),
    occ = map(occ, \(x) {
      select(x, gbif_key = key, scientific_name, genus, species, longitude, 
             latitude)
    })
  )
  write_tsv(unnest(flora, cols = c(occ)), derived_data("flora_occ.tsv"))
}
flora <- read_tsv(
  derived_data("flora_occ.tsv"),
  col_types = cols(
    taxon = col_character(),
    taxon_detail = col_character(),
    n_present = col_double(),
    p_present = col_double(),
    n_occ = col_double(),
    gbif_key = col_double(),
    scientific_name = col_character(),
    genus = col_character(),
    species = col_character(),
    longitude = col_double(),
    latitude = col_double()
  )
) |>
  nest(occ = gbif_key:latitude)
```

```{r fig-occ-map, fig.cap=paste0("Georeferenced occurrence records from West Asia for the ", nrow(flora), " modelled taxa (N=", nrow(unnest(flora, occ)))}
flora |>
 unnest(occ) |>
 distinct(latitude, longitude) |>
 st_as_sf(coords = c("longitude", "latitude"), crs = 4326) |>
 ggplot() +
 annotation_spatial(ne_land, fill = "#ffffff") +
 geom_sf(shape = ".") +
 layer_spatial(w_asia, fill = NA) +
 coord_sf(crs = w_asia_albers, default_crs = latlong)
```

```{r data-background}
# TODO: slow - cache
flora <- flora |>
  mutate(
    occ = map(occ, mutate, present = TRUE, weight = 1),
    bg = map(occ, function(x, region, n) { 
      background_sample(
        region = region, 
        N = n,
        coord_x = "longitude", coord_y = "latitude",
        present = FALSE,
        weight = (1 / n) * nrow(x) # weight presences and background equally
      )
    }, region = w_asia_land, n = n_background),
    # occ_bg = map2(occ, bg, bind_rows)
    occ = map2(occ, bg, bind_rows)
  ) |>
  select(-bg)
```

<!-- TODO: rewrite -->
Occurrence data only tells us where a species is present;
there is rarely definitive information on where the species is *not* found.
We therefore need to generate random background points or "pseudo-absences" to feed to the model.
There are several ways to do this. 
We follow the advice of @BarbetMassinEtAl2012 for regression-based species distribution models and use a large (:10000) random sample of points, weighted equally against the presences in the regression.
@ValaviEtAl2022 also recommend using a very large background sample for random forest models.

## Predictor data

We modelled the occurrence of species as a function of <!-- TODO -->X spatial predictor variables (@tbl-predictors).
These included:

```{r data-climate}
# Reacquire derived_data/paleoclim if needed:
if (length(dir_ls(derived_data("paleoclim"), glob = "*.tif")) < 1) {
  message("Redownloading Paleoclim data...")
  source(here("data", "data-paleoclim.R"))
}

climate <- read_stars(
  derived_data(
    "paleoclim", 
    paste0("paleoclim_", climate_periods$code, "_2_5m_w_asia.tif")
  ),
  along = NA
)

names(climate) <- climate_periods$code

climate <- st_redimension(climate, name = "period") |>
  split("band")
```

* Sixteen 'bioclimatic' variables derived from monthly temperature and precipitation values, following standard practice for species distribution models [@HijmansEtAl2005]. Contemporary bioclimatic predictor data for West Asia was extracted from the global CHELSA dataset [@KargerEtAl2017], which predicts temperature and precipitation from downscaled general circulation model output at 1 km resolution.

```{r data-terrain}
# Reacquire derived_data/srtm_15plus_w_asia.tif if needed:
if (!file_exists(derived_data("dem", "srtm_15plus_w_asia.tif"))) {
  message("Redownloading DEM data...")
  source(here("data", "data-dem.R"))
}

terrain <- read_stars(derived_data("dem", c("srtm_15plus_w_asia.tif", 
                                            "srtm_15plus_w_asia_slope.tif",
                                            "srtm_15plus_w_asia_aspect.tif",
                                            "srtm_15plus_w_asia_wetness.tif")))
names(terrain) <- c("elevation", "slope", "aspect", "wetness")
```

* Terrain aspect and slope, which at high resolution perform well as proxies for solar radiation when modelling plant occurrence [@AustinVanNiel2011; @LeempoelEtAl2015]; and the topographic wetness index (TWI), which serves as a proxy for soil moisture and is particularly important in modelling arid environments [@KopeckyCizkova2010; @CamposEtAl2016; @DiVirgilioEtAl2018]. All three were derived from the SRTM15+ digital elevation model using algorithms from WhiteboxTools [@Lindsay2016].

```{r data-soil}
# Reacquire derived_data/soilgrids if needed:
if (length(dir_ls(derived_data("soilgrids"), glob = "*.tif")) < 1) {
  message("Redownloading SoilGrids data...")
  source(here("data", "data-soilgrids.R"))
}

soil <- map(dir_ls(derived_data("soilgrids")), read_stars)
names(soil) <- str_split_i(basename(names(soil)), "_", 2)
soil <- do.call(c, soil)
```

* Edaphic data from SoilGrids [@HenglEtAl2014; @HenglEtAl2017], which improves model performance for plants [@DubuisEtAl2013; @ModEtAl2016; @VelazcoEtAl2017]. Based on a recent assessment of the reliability of SoilGrids data for species distribution modelling [@MillerEtAl2024], we used a subset of four variables relating to soil texture (clay, silt, sand) and pH at the surface (0-5 cm depth).

```{r data-environment}
# Prepare environmental data cube for prediction (not training)
# Duplicate time-invariant predictors to create dummy period dimension
terrain_cube <- list(terrain) |>
  rep(nrow(climate_periods)) |>
  set_names(climate_periods$code) |>
  c(list(along = "period")) |>
  do.call(what = c)

soil_cube <- list(soil) |>
  rep(nrow(climate_periods)) |>
  set_names(climate_periods$code) |>
  c(list(along = "period")) |>
  do.call(what = c)

# Resample predictor data to common projection and resolution
climate_cube <- st_warp(climate, crs = w_asia_albers, 
                        cellsize = c(pred_res, pred_res), segments = 1000)
terrain_cube <- st_warp(terrain_cube, climate_cube, segments = 1000)
soil_cube <- st_warp(soil_cube, climate_cube, segments = 1000)

# Combine into prediction cube
environment <- c(climate_cube, terrain_cube, soil_cube)

# Save some memory
rm(climate_cube, terrain_cube, soil_cube)
```

Predictor data was transformed to common equal-area projection and resolution of `r pred_res / 1000` km.

```{r tbl-climate-periods}
#| fig-cap: Palaeoclimatic periods used for hindcasting, after @BrownEtAl2018
# TODO: integrate into text
climate_periods |>
  mutate(
    code = toupper(code),
    age_start = start_bp / 1000,
    age_end = end_bp / 1000
  ) |>
  select(period, code, age_start, age_end) |>
  gt() |>
  cols_label(period = "Period", age_start = "Age") |>
  cols_merge(
    c(period, code),
    pattern = "{1} ({2})"
  ) |>
  cols_merge_range(age_start, age_end) |>
  cols_units(age_start = "ka") |>
  sub_missing()
```

For hindcasting, we used reconstructed bioclimatic data for `r english(nrow(climate_periods) - 1)` key periods (@tbl-climate-periods) generated from downscaled paleoclimate simulations from the HadCM3 general circulation model [@BrownEtAl2018].
Terrain and soil predictors were held constant, since reconstructions of these variables in the past are not available at sufficient scale.
It is not likely that either macroscale topography or soil characteristics have altered significantly over the period of time considered here, so we assume that this does not degrade model performance, and may in fact benefit it by providing 'anchoring' predictors that are independent of climate change.

```{r data-flora-predictors}
# TODO: factor out
bind_extract <- function(x, y) {
  extract <- st_extract(y, st_transform(x, st_crs(y)))
  cbind(x, select(tibble(extract), -geometry))
}

flora <- flora |> 
  mutate(
    occ = map(occ, st_as_sf, coords = c("longitude", "latitude"), crs = latlong, remove = FALSE),
    occ = map(occ, bind_extract, slice(climate, "period", "cur")),
    occ = map(occ, bind_extract, terrain),
    occ = map(occ, bind_extract, soil)
  )
```

## Random Forest

```{r niche-data}
# Split training, test (for model assessment) and cross-validation sets (for
# tuning)
flora <- flora |>
  mutate(
    # De-sf
    occ = map(occ, \(x) select(tibble(x), -geometry)),
    # TODO: can this happen earlier?
    occ = map(occ, \(x) mutate(x, present = factor(present, c(FALSE, TRUE)))),
    occ = map(occ, \(x) mutate(x, weight = importance_weights(weight))),
    # occ = map(occ, \(x) drop_na(x, starts_with("bio"))), # TODO: where do these come from?
    occ_split = map(occ, \(x) initial_split(x, strata = present)),
    # occ_folds = map(occ_split, \(x) vfold_cv(training(x), v = 10, strata = present))
  )

# Data preprocessing recipe
# Following recommended preprocessing steps for RF classification from:
#   https://www.tmwr.org/pre-proc-table.html
niche_recipe <- recipe(training(flora$occ_split[[1]])) |>
  update_role(gbif_key:latitude, new_role = "ID") |>
  update_role(present, new_role = "outcome") |>
  update_role(starts_with("bio"), new_role = "predictor") |>
  update_role(c(elevation, slope, aspect, wetness, clay, phh2o, sand, silt),
              new_role = "predictor") |>
  # Impute missing values based on spatial autocorrelation
  step_impute_linear(all_numeric_predictors(), 
                     impute_with = imp_vars(latitude, longitude)) |>
  # Drop redundant predictors
  step_nzv(all_predictors())
```

Ecological niche modelling is a classification problem that can be approached with a wide range of statistical methods.
A substantial literature exists on the relatively performance of these approaches and their respective parameterisations [reviewed in @ValaviEtAl2022].
Random Forest, a widely-used machine learning algorithm, is amongst the best performing methods for presence-only species distribution models, providing it is appropriately parameterised to account for the class imbalance between presence and background samples [@ValaviEtAl2021; @ValaviEtAl2022].
For our application, it also has the advantage of requiring little to no manual parameter tuning to achieve good predictive results, which makes it easier to model a larger numbers of taxa.

```{r niche-model}
# Random Forest Niche Model
# With hyperparameters adapted from the example of a down-sampled RF model given 
# by https://rvalavi.github.io/SDMwithRFs/#model-fitting-with-ranger-package
niche_model <- rand_forest(mode = "classification", trees = 1000) |>
  set_engine(
    "ranger", 
    sample.fraction = c(sum(as.logical(.y())) / n_background, 1),
    # probability = TRUE
  )

niche_workflow <- workflow(niche_recipe, niche_model)
```

For each taxon we trained a classification model to predict occurrence (presence or absence/background) based on our X<!--TODO--> predictor variables (@tbl-predictors).
We used the Random Forest algorithm implemented in the R package 'ranger' [@WrightZiegler2017] and the 'tidymodels' [@tidymodels] framework for data preprocessing and model selection.
To avoid overfitting, we follow @ValaviEtAl2021 in their recommended hyperparameters and use of down-sampling to balance presence and background samples.
Models for each taxon were fit independently, with redundant zero-variance predictors excluded, and assessed based on balanced training (¾) and test (¼) partitions.

```{r niche-fit}
# Fit best model to training data
if (!file_exists(derived_data("flora_niche_fit.Rdata"))) {
  flora <- mutate(
    flora,
    niche = map(occ_split, \(x) last_fit(niche_workflow, x), .progress = TRUE)
  )
  saveRDS(flora, derived_data("flora_niche_fit.Rdata"))
}
flora <- readRDS(derived_data("flora_niche_fit.Rdata"))
```

<!-- TODO: prediction, hindcasting and hindcasting assessment methodology -->

# Model assessment

```{r niche-predict}
# NOTE: high memory usage
if (!file_exists(derived_data("flora_niche_predictions.Rdata"))) {
  flora <- flora |>
    mutate(
      pred = map(niche, collect_predictions),
      palaeodist = map(niche, \(mod, obj) predict(obj, extract_fit_engine(mod)),
                       obj = environment, .progress = TRUE),
      # Binarize
      palaeodist = map(palaeodist, mutate, present = prediction.TRUE. > 0.5),
      palaeodist = map(palaeodist, mutate, absent = prediction.FALSE. > 0.5)
    )
  saveRDS(flora, derived_data("flora_niche_predictions.Rdata"))
}
flora <- readRDS(derived_data("flora_niche_predictions.Rdata"))
```

We trained Random Forest models for `r nrow(flora)` taxa using contemporary occurrence data from GBIF, a random sample of background points, and the predictor variables described in @tbl-predictors.
Substituting the "current" climate predictors for those derived from palaeoclimatic simulations [@BrownEtAl2018], we could then generate hindcast predictions for reconstructed past environments in `r english(nrow(climate_periods))` key climate periods – a total of `r nrow(flora) * nrow(climate_periods)` modelled palaeodistributions.
Predicted distributions for individual taxa are presented in the appendix and accompanying material.

```{r data-model-assessment}
flora <- mutate(
  flora,
  pred = map(niche, collect_predictions),
  niche_test_metrics = map(niche, collect_metrics),
  sensitivity = map(pred, sens, truth = present, estimate = .pred_class,
                    event_level = "second"), # reference present=TRUE
  niche_test_metrics = map2(niche_test_metrics, sensitivity, bind_rows)
) |>
  select(-sensitivity)

niche_test_metrics <- flora |>
  unnest(niche_test_metrics) |>
  summarise(
    min = min(.estimate),
    max = max(.estimate),
    mean = mean(.estimate),
    sd = sd(.estimate),
    .by = c(.metric)
  )
```

```{r fig-model-sensitivity-vs-n_occ, warning=FALSE}
#| fig-cap: Model sensitivity by number of training occurrences
flora |>
  unnest(niche_test_metrics) |>
  filter(.metric == "sens") |>
  mutate(label = if_else(.estimate < 0.85, taxon, NA_character_)) |>
  ggplot(aes(n_occ, .estimate)) + 
  geom_smooth(method = "glm", formula = y ~ log(x)) +
  geom_point() + 
  geom_text_repel(aes(label = label), fontface = "italic", size = 10/.pt) +
  scale_x_log10(name = "Occurrences") +
  scale_y_continuous(name = "Sensitivity", labels = label_percent()) +
  theme_minimal_grid() 
```

We assessed the predictive performance of the fitted niche models in the contemporary environment based on the reserved test partition.
Model accuracy (proportion of correctly classified presence and background samples) ranged between `r percent(filter(niche_test_metrics, .metric == "accuracy")$min)` and `r percent(filter(niche_test_metrics, .metric == "accuracy")$max)`, with an average of `r percent(filter(niche_test_metrics, .metric == "accuracy")$mean)`.
Sensitivity (proportion of correctly classified presence samples) ranged between `r percent(filter(niche_test_metrics, .metric == "sens")$min)` and `r percent(filter(niche_test_metrics, .metric == "sens")$max)`, with an average of `r percent(filter(niche_test_metrics, .metric == "sens")$mean)`.
The area under the models' receiver operating characteristic curves (ROC-AUC) was in the range of `r round(filter(niche_test_metrics, .metric == "roc_auc")$mean, 3)`±`r round(filter(niche_test_metrics, .metric == "accuracy")$sd, 3)`
Model sensitivity is loosely correlated with the number of occurrences available for training (@fig-model-sensitivity-vs-n_occ), with the worst-performing models all having less than 300 recorded occurrences: `r knitr::combine_words(paste0("*", filter(unnest(flora, niche_test_metrics), .metric == "sens" & .estimate < 0.85)$taxon, "*"))`.
Test metrics and ROC curves for the individual models are included in the appendix.

```{r niche-archaeo}
# TODO: factor out
# TODO: what about negatives?
archaeo_flora_predictions <- 

archaeo_flora |>
  filter(taxon %in% flora$taxon) |>
  st_as_sf(coords = c("longitude", "latitude"), crs = latlong) |>
  mutate(
    prediction = map(taxon, \(x) filter(flora, taxon == x)$palaeodist[[1]]),
    prediction = map2(prediction, geometry, function(pred, geom) {
      sf_point <- st_transform(st_sf(st_sfc(geom, crs = latlong)), w_asia_albers)
      st_extract(pred, sf_point)
    }),
    prediction = map(prediction, as_tibble),
    prediction = map2(prediction, climate_period, function(pred, per) {
      filter(pred, as.character(period) == per)
    }),
    prediction = map(prediction, select,
                     pred_present = present, pred_absent = absent)
  ) |>
  unnest(c(prediction))

p_archaeo_pred_correct <- sum(archaeo_flora_predictions$pred_present, na.rm = TRUE) / length(!is.na(archaeo_flora_predictions$pred_present))

archaeo_flora_pred_summary <- archaeo_flora_predictions |>
  as_tibble() |>
  summarise(
    n_present = sum(!is.na(pred_present)),
    n_predicted = sum(pred_present, na.rm = TRUE),
    p_predicted = n_predicted / n_present,
    .by = c(climate_period, site_name, phase_code, age_mid)
  )
```

The ability of the hindcast models to predict the occurrence of specific species at archaeological sites is significantly worse, with only `r percent(p_archaeo_pred_correct)` of presences in archaeobotanical assemblages successfully predicted.
<!-- TODO: negative -->

```{r niche-pred-range}
area_present <- function(pred, res = pred_res) {
  st_apply(pred, "period", sum, na.rm = TRUE)["present"] |>
    data.frame() |>
    mutate(area_present = present * (pred_res)^2) |>
    select(period, area_present)
}

flora <- mutate(flora, area_present = map(palaeodist, area_present))
```

# Results

## Reduction in range sizes over the Pleistocene/Holocene boundary

```{r fig-range-density}
#| fig-cap: Distribution of predicted species ranges by period. Dashed lines indicate the median range.
flora_pred_area_present_summary <- flora |>
  unnest(area_present) |>
  summarise(med_area_present = median(area_present) / 1e6, .by = period) |>
  mutate(
    period_label = map(period, \(x) filter(climate_periods, code == x)$label),
    period_label = unlist(period_label),
  )
  
flora |>
  unnest(area_present) |> 
  mutate(
    period_label = map(period, \(x) filter(climate_periods, code == x)$label),
    period_label = unlist(period_label),
    area_present = area_present / 1e6 # m2 to km2
  ) |> 
  ggplot() + 
  facet_wrap(vars(period_label), ncol = 1, strip.position = "left") + 
  geom_density(aes(area_present)) +
  geom_vline(aes(xintercept = med_area_present), flora_pred_area_present_summary) +
  scale_x_log10(name = "Predicted range km²", labels = label_number_auto()) + 
  scale_y_continuous(name = NULL, labels = NULL) +
  theme_minimal_vgrid() +
  theme(
    strip.text.y.left = element_text(angle = 0, hjust = 0),
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank()
  )
```

Species ranges are predicted to have been signicantly smaller in the terminal Pleistocene and Early Holocene that under current conditions [@fig-range-density], though the magnitude of this change is likely also to reflect a degree of overfitting in the model (see below).
Fluctuations in modelled range size between the Bølling-Allerød (14.7–12.9 ka), Younger Dryas (12.9–11.7 ka), and Early Holocene (11.7–8.3 ka) are more directly comparable.
The average range of modelled species shrank by `r percent(1 - (filter(flora_pred_area_present_summary, period == "eh")$med_area_present / filter(flora_pred_area_present_summary, period == "ba")$med_area_present))` over the Pleistocene–Holocene boundary, with a noticeable dip in the Younger Dryas.
This perhaps indicates that although this period is considered one of climatatic amelioration globally [@JonesEtAl2019], the colder conditions of the Pleistocene may have supported more extensive plant-based economies in West Asia specifically.

<!-- TODO: map of sum species abundance? -->

Many taxa that occur (or are predicted to occur) across the 'hilly flanks' today—including most crop progenitors—are reconstructed to have had a significantly more restricted distribution in the terminal Pleistocene/Early Holocene.
These include *Ficus carica* (fig);
*Hordeum* spp. (wild barleys);
*Lathyrus aphaca* and *L. sativus* (both marginally edible legumes);
*Triticum aestivum compactum* (in the N. Levant), *T. monococcum aegilopoides*, *T. durum*, and *Triticum urartu* (but not the other wheat progenitor, *T. turgidum dicoccum* – see below);
*Aegilops speltoides*, but not *Aegilops tauschii* (goatgrasses);
and *Vicia* spp. (vetches), including *Vicia faba* (broad beans).
most of Anatolia, Northern Mesopotamia, and the Zagros Mountains in particular disappear from the predicted ranges of these species,
leaving the Levant and to a lesser extent the Aegean and Cyprus as refugia.

Our results for the Levant are consistent with the current understanding of this region as developing early intensive foraging economies [the Natufian culture, @] and as a centre of origin of agriculture [@].
Within the Levant, retreat from the Badia.

Loss of the Northern Mesopotamia–Anatolia region from the predicted ranges of crop progenitors is interesting in light of the 'golden triangle' hypothesis [@Lev-YadunEtAl2000; @KozlowskiAurenche2005; @AbboEtAl2010], which puts this region at the centre of the development of agriculture.
Multiple lines of archaeological evidence have emerged that point away from this hypothesis and towards a more geographically diverse origin [@Asouti2006; @cites], but it remains the area with some of the earliest clear evidence of domestication [@ZoharyHopfWeiss2012; @KabukcuEtAl2021; @UlasEtAl2024].
Comparative genetics also points to the Northern Mesopotamia region as the centre of diversity of many crops [e.g. @HaasEtAl2019].
But since these studies are based on modern genomes, if the wild range of these plants has, as our modelling suggests, shifted since the Early Holocene, the apparent centre of diversity may have shifted with them.
Our reconstructions are consistent with the late arrival of intensive plant-based foraging economies in this region (cf. the Natufian of the Levant),
and more broadly there need not be a link between the core *wild* range of a plant and the core area of its domestication. 
A scenario in which cultivation emerged at the edges of the ranges of valuable plant resources—as a means of extend their natural niche—is also plausible.

The near-absence of the Zagros in any predicted ranges is also surprising, given mounting evidence that domestication took place just as early in the eastern *Mashriq* as it did in the west [@Braidwood; @GanjDarehGoats; @HillyFlanksStuff].
We consider that the most likely explanation for this is that our flora does not include the species that were most important to plant subsistence in the east.
Archaeobotanical data on Neolithic sites in the Zagros is limited (compared to the Levant in particular) due to a hiatus in field research there from the 1980s to early 2010s [@cite].
Recent research [@Amaia?] indicates ... <!-- TODO: weird plants -->

Cyprus and the Aegean are not conventionally considered part of the primary zone of domestication but rather amongst the first regions that acquired agriculture from West Asia.
Our analysis complicates this picture, as it indicates that the wild ranges of many crop progenitors included these regions.
Early examples of several domesticates are recorded at sites on Cyprus, Western Anatolia and Greece [@ArranzOtaeguiRoe2023],
and the Aegean region was probably connected to West Asia by a land bridge via Anatolia until the Early Holocene [@AksuHiscott2022].
Were these area part of the same broader 'interaction sphere' [@cite] that produce Neolithic agriculture in West Asia?

Exceptions to the dominant trend of range reduction include *Cicer reticulatum* (wild chickpea), which has a relatively stable range centered on Northern Mesopotamia;
and *Triticum turgidum dicoccum* (wild emmer wheat), which is predicted to have two limited ranges centered around the Black Sea Coast of Anatolia and the Palmyra basin.
In the latter case, neither of these areas are part of the predicted modern distribution of wild emmer (centered around the Caucasus and Northern Mesopotamia), but it would be consistent with archaeological evidence for early cultivation at sites in the Upper Euphrates [@Willcox2024].

## Biogeography of crop progenitors

* Most cereal and legume crops predicted to be Levantine
* Cereals show diverging southern/northern ranges (legumes not so much)
* Not rye (Anatolia), chickpea (N. Mesopotamia)

```{r fig-hindcast-barely-levant, eval=FALSE, cache=TRUE}
#| fig-cap: Predicted palaeodistribution of wild barleys in the Levant
palaeodist_hordeum <- do.call(c, c(
  filter(flora, str_starts(taxon, "Hordeum"))$palaeodist,
  list(along = list(taxon = filter(flora, str_starts(taxon, "Hordeum"))$taxon))
))

# TODO: expand period facet labels
ggplot() +
  facet_grid(taxon ~ period) +
  annotation_spatial(ne_land, fill = "white") +
  geom_stars(data = select(palaeodist_hordeum, prediction.TRUE.), 
             na.action = na.omit) +
  annotation_spatial(ne_land, fill = NA) +
  annotation_spatial(w_asia, fill = NA) +
  scale_x_continuous(breaks = c(34, 36, 38)) +
  scale_fill_batlow(reverse = TRUE) +
  coord_sf(
    xlim = c(33, 39), ylim = c(30, 38),
    crs = w_asia_albers, default_crs = latlong
  ) +
  labs(fill = "P(present)", x = NULL, y = NULL) +
  theme(
    strip.background = element_blank(),
    strip.text.y = element_text(face = "italic")
  )
```

```{r fig-hindcast-wheat-levant, eval=FALSE, cache=TRUE}
#| fig-cap: Predicted palaeodistribution of wild wheat in the Levant
palaeodist_triticum <- do.call(c, c(
  filter(flora, str_starts(taxon, "Triticum"))$palaeodist,
  list(along = list(taxon = filter(flora, str_starts(taxon, "Triticum"))$taxon))
))

# TODO: expand period facet labels
ggplot() +
  facet_grid(taxon ~ period) +
  annotation_spatial(ne_land, fill = "white") +
  geom_stars(data = select(palaeodist_triticum, prediction.TRUE.)) + 
  annotation_spatial(ne_land, fill = NA) +
  annotation_spatial(w_asia, fill = NA) +
  scale_x_continuous(breaks = c(34, 36, 38)) +
  scale_fill_batlow(reverse = TRUE) +
  coord_sf(
    xlim = c(33, 39), ylim = c(30, 38),
    crs = w_asia_albers, default_crs = latlong
  ) +
  labs(fill = "P(present)", x = NULL, y = NULL) +
  theme(
    strip.background = element_blank(),
    strip.text.y = element_text(face = "italic")
  )
```

<!-- TODO binarized range figure other founder crops? -->

Wild barley [*Hordeum spontaneum*, @fig-hindcast-barely-levant] and pistachio [*Pistacia atlantica*, @fig] show a contraction of their predicted ranges from the Pleistocene to the Holocene,
concurrent with them being brought into cultivation.
Plausible that this prompted cultivation?
These two species [@ArranzOtaeguiRoe2023] also see marked declines in the archaeobotanical record from the Early PPNA/Early PPNB (where they were amongst the most common taxa) to the Late PPNB and Late Neolithic.
However, this trend is not seen in most other crop progenitors.

Cereals / other progenitors (not all) reduced in range before cultivation?
Reduction in range from BA to EH very evident in Hordeum, less so in ...

<!-- TODO: composite wheat progentor figure -->

The wheat story.

<!-- TODO: figure with flax, Pistacia, Bolboschoenus --> 

Flax has a very restricted distribution (consistent with low occurrence in founders paper?).
As does Pistacia atlantica, Bolboschoenus maritimus

<!-- TODO: figure with rye -->

*Secale cereale* = an Anatolian boy

## Hindcast models do not predict archaeobotanical composition

The failure of our hindcast models to predict the occurrence of species in archaeobotanical assemblages has several possible explanations. 
Since they do accurately predict the test dataset <!-- TODO: and past negatives? -->, a likely culprit is overfitting of the models to the present environment.
This implies that the modelled palaeodistributions should be seen as conservative estimates or a minimal range.
Another obvious flaw in our methodology is that the time slices used for palaeoclimatic reconstruction are very broad—each covering around two millennia—and therefore potentially unrepresentative of the environment around sites at the specific time at which they were occupied.
The variable quality of the archaeological test dataset, especially in terms of chronology, is also a plausible factor.

At the same time, we cannot rule out more substantive reasons for the discrepency between predicted and observed archaeological occurrences.
The niches of the modelled species could have changed since the Early Holocene, which would not be captured in a model trained purely on modern specimens.
Human economic choices—mobility, foraging strategies, cultivation, etc.—could also produce archaeobotanical assemblages whose composition depart significantly from that of the surrounding local flora.
Further refinement of the methodology for hindcast palaeoecological niche models, for example using more finely resolved palaeoclimate sequences [e.g. @KargerEtAl2023], hyperparameter tuning to avoid overfitting, and improved archaeological datasets, would help disentangle these potential explanations.

<!-- TODO: do model predictions match more aggregated stats e.g. biodiversity? -->
Is inconsistent with more "macro" trends such as the reduced range of Hordeum and Pistacia correlating with its reduced abundance in the archaeobotanical record.

# Discussion

* We present the first continuous, spatially explicit models of the palaeodistributions of 56 plant species found regularly in association with early agricultural archaeological sites in West Asia
  * A new line of evidence on archaeoecology
  * Complementary to archaeobot/pollen/etc. because it is independent from it
  * All models are wrong... but it's easier to see how these are wrong than lines on maps
* Modelling at scale using random forest, modern occurrences, and hindcasting represents a significant advance in pENM methodology
  * Relies on recent open ecological and climatic datasets
  * ...open archaeological datasets still lacking!
* First (? - check Yaworsky) attempt to verify hindcast models with archaeo. compositional data
  * Results not to promising, but this doesn't mean the models are useless!
  * Discrepencies suggests several areas for further research and methodological development

# References {.appendix}

----

```{r fig-niche-prediction, eval=FALSE}
# "Adonis flammea"                   "Aegilops crassa"                  "Aizoanthemopsis hispanica"       
# "Ammi majus"                       "Androsace maxima"                 "Arnebia decumbens"               
# "Arnebia linearifolia"             "Atriplex prostrata"               "Bassia arabica"                  
# "Bolboschoenus maritimus"          "Brachypodium distachyon"          "Bromus sterilis"                 
# "Buglossoides arvensis"            "Buglossoides tenuiflora"          "Capparis spinosa"                
# "Carex divisa"                     "Cephalaria syriaca"               "Chenopodium album"               
# "Cicer reticulatum"                "Ficus carica"                     "Fumaria densiflora"              
# "Gypsophila pilosa"                "Helianthemum ledifolium"          "Hordeum bulbosum"                
# "Hordeum murinum"                  "Hordeum spontaneum"               "Lathyrus aphaca"                 
# "Lathyrus sativus"                 "Vicia orientalis"                 "Linum bienne"                    
# "Lolium rigidum"                   "Lolium temulentum"                "Medicago radiata"                
# "Phalaris paradoxa"                "Pistacia atlantica"               "Lathyrus oleraceus"              
# "Poa bulbosa"                      "Prosopis farcta"                  "Quercus ithaburensis"            
# "Rumex pulcher"                    "Salsola kali"                     "Secale cereale"                  
# "Taeniatherum caput-medusae"       "Medicago astroites"               "Triticum aestivum compactum"     
# "Triticum turgidum dicoccum"       "Triticum monococcum aegilopoides" "Triticum durum"                  
# "Gypsophila vaccaria"              "Verbena officinalis"              "Vicia ervilia"                   
# "Vicia faba"                       "Vicia narbonensis"                "Triticum urartu"                 
# "Aegilops speltoides"              "Aegilops tauschii"               

niche_taxon <- "Lathyrus oleraceus"
niche_prediction <- filter(flora, taxon == niche_taxon)$palaeodist[[1]]

# Order and relabel periods
ggplot() + 
  facet_wrap(~period, ncol = 2) +
  annotation_spatial(ne_land, fill = "white") +
  geom_stars(data = select(niche_prediction, prediction.TRUE.),
             na.action = na.omit) +
  annotation_spatial(ne_land, fill = NA) +
  annotation_spatial(w_asia, fill = NA) +
  scale_fill_batlow(reverse = TRUE) +
  coord_sf(crs = w_asia_albers) +
  labs(
    title = niche_taxon,
    fill = NULL,
    x = NULL,
    y = NULL
  ) +
  theme(
    plot.title = element_text(face = "italic")
  )
```

```{r sum-pred-eh, eval=FALSE}
flora |>
  mutate(pred_eh = map(fit, \(x) predict(climate$EH, model = x, type = "prob"))) ->
  x

pred_eh <- x$pred_eh
names(pred_eh) <- x$taxon
pred_eh <- do.call(c, map(pred_eh, select, .pred_TRUE))
pred_eh <- merge(pred_eh, name = "taxon")
sum_pred_eh <- st_apply(pred_eh, c("x", "y"), sum, na.rm = TRUE)
```

```{r fig-sum-pred-eh, eval=FALSE}
#| fig-cap: predicted species richness for the early Holocene
ggplot() + 
  geom_stars(data = sum_pred_eh) +
  scale_fill_batlow(reverse = FALSE) +
  coord_sf(crs = latlong) +
  labs(
    title = "Predicted species richness",
    subtitle = "Early Holocene (11.7–8.326 ka)",
    fill = NULL,
    x = NULL,
    y = NULL
  )

saveRDS(pred_eh, "pred_eh.Rdata")
```
